define(["knockout","Q"],function(e,t){function n(e,t){for(var n in e)et(e,n)&&t(n,e[n])}function r(e,t){for(var n in e)if(et(e,n)){var r=e[n];if(t(n,r))return{key:n,value:r}}return null}function a(e,t){var n=[];for(var r in e)if(et(e,r)){var a=t?t(r,e[r]):e[r];void 0!==a&&n.push(a)}return n}function i(e,t){return function(n){return n[e]===t}}function o(e){return function(t){return t[e]}}function s(e){var t=[];for(var n in e)et(e,n)&&t.push(e[n]);return t}function u(e,t){if(!t)return e;for(var n in t)et(t,n)&&(e[n]=t[n]);return e}function p(e,t){for(var n in t)void 0===e[n]&&(e[n]=t[n]);return e}function c(e,t){return t.defaultInstance=p(new t(e),t.defaultInstance),e}function y(e,t){var n={};for(var r in t)if(r in e){var a=e[r],i=t[r];a!=i&&(Array.isArray(a)&&0===a.length||("function"==typeof i?a=i(a):"object"==typeof a&&a&&a.parentEnum&&(a=a.name),void 0!==a&&(n[r]=a)))}return n}function l(e,t){var n={},r=e.length;return t.forEach(function(t){for(var a=0;r>a;a++){var i=e[a];if(i){var o=i[t];if(void 0!==o){n[t]=o;break}}}}),n}function f(e){return e?Array.isArray(e)?e:[e]:[]}function h(e,t){for(var n=0,r=e.length;r>n;n++)if(t(e[n]))return e[n];return null}function d(e,t){for(var n=0,r=e.length;r>n;n++)if(t(e[n]))return n;return-1}function m(e,t,n){for(var r=A(t)?t:void 0,a=e.length-1,i=!1,o=a;o>=0;o--)if((r?r(e[o]):e[o]===t)&&(e.splice(o,1),i=!0,!n))return i;return i}function g(e,t,n){for(var r=[],a=Math.min(e.length,t.length),i=0;a>i;++i)r.push(n(e[i],t[i]));return r}function v(e,t,n){if(!e||!t)return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(Array.isArray(e[r])){if(!v(e[r],t[r]))return!1}else if(n){if(!n(e[r],t[r]))return!1}else if(e[r]!==t[r])return!1;return!0}function S(e,t){var n=e[t];return n||(n=[],e[t]=n),n}function w(e,t){for(var n=e.split(";"),r=0,a=n.length;a>r;r++){var i=E(n[r]);if(i)return i}if(t)throw new Error("Unable to initialize "+e+".  "+t||"")}function E(e){var t;try{if(this.window){var n=this.window;if(t=n[e])return t;if(n.require&&(t=n.require(e)),t)return t}require&&(t=require(e))}catch(r){}return t}function P(e,t,n,r){var a=e[t];if(n===a)return r();e[t]=n;try{return r()}finally{void 0===a?delete e[t]:e[t]=a}}function T(e,t,n){var r;try{return r=e(),n()}catch(a){throw"object"==typeof r&&(r.error=a),a}finally{t(r)}}function _(e){return function(){for(var t=tt(arguments),n="",r=t.length,a=null;r--;)a=t[r],n+=a===Object(a)?JSON.stringify(a):a,e.memoize||(e.memoize={});return n in e.memoize?e.memoize[n]:e.memoize[n]=e.apply(this,t)}}function N(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})}function b(e){if("string"!=typeof e)throw new Error("Invalid ISO8601 duration '"+e+"'");var t=/^P((\d+Y)?(\d+M)?(\d+D)?)?(T(\d+H)?(\d+M)?(\d+S)?)?$/.exec(e);if(!t)throw new Error("Invalid ISO8601 duration '"+e+"'");for(var n=[2,3,4,6,7,8],r=[31104e3,2592e3,86400,3600,60,1],a=0,i=0;6>i;i++){var o=t[n[i]];o=o?+o.replace(/[A-Za-z]+/g,""):0,a+=o*r[i]}return a}function O(e){return null===e?"null":void 0===e?"undefined":Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function C(e){return"date"===O(e)&&!isNaN(e.getTime())}function A(e){return"function"===O(e)}function x(e){return"string"==typeof e&&/[a-fA-F\d]{8}-(?:[a-fA-F\d]{4}-){3}[a-fA-F\d]{12}/.test(e)}function M(e){return"string"==typeof e&&/^(-|)?P([0-9]+Y|)?([0-9]+M|)?([0-9]+D|)?T?([0-9]+H|)?([0-9]+M|)?([0-9]+S|)?/.test(e)}function k(e){if(null===e||void 0===e)return!0;for(var t in e)if(et(e,t))return!1;return!0}function I(e){return!isNaN(parseFloat(e))&&isFinite(e)}function D(e,t){return e&&t?0===e.indexOf(t,0):!1}function V(e,t){return e&&t?-1!==e.indexOf(t,e.length-t.length):!1}function F(e){var t=arguments,n=RegExp("%([1-"+(arguments.length-1)+"])","g");return e.replace(n,function(e,n){return t[n]})}function K(e){var t=Function.call;return function(){return t.apply(e,arguments)}}function j(e,t,n){void 0===t&&(t=null);var r=n(),a=e.dataType;if(a&&a.parse&&(t=Array.isArray(t)&&!e.isScalar?t.map(function(e){return a.parse(e,typeof e)}):a.parse(t,typeof t)),!(t===r||a&&a.isDate&&t&&r&&t.valueOf()===r.valueOf())){var i,o,s,u=this,p=e.name,c=this.entityAspect;c?i=c:(i=this.complexAspect,c=i.getEntityAspect());var y=i.getPropertyPath(p),l=c._inProcess;if(l){if(l.indexOf(e)>=0)return;l.push(e)}else l=[e],c._inProcess=l;var f=c.entity;try{var h=c.entityManager;if(c.entityState.isUnchangedOrModified()&&void 0===i.originalValues[p]&&e.isDataProperty&&!e.isComplexProperty&&(i.originalValues[p]=void 0!==r?r:e.defaultValue),e.isComplexProperty){if(!e.isScalar)throw new Error(F("You cannot set the non-scalar complex property: '%1' on the type: '%2'.Instead get the property and use array functions like 'push' or 'splice' to change its contents.",e.name,e.parentType.name));if(!t)throw new Error(F("You cannot set the '%1' property to null because it's datatype is the ComplexType: '%2'",e.name,e.dataType.name));if(!r){var d=a.getCtor();r=new d,n(r)}a.dataProperties.forEach(function(e){var n=e.name,a=t.getProperty(n);r.setProperty(n,a)})}else if(e.isDataProperty){if(!e.isScalar)throw new Error("Nonscalar data properties are readonly - items may be added or removed but the collection may not be changed.");if(e.isPartOfKey&&!this.complexAspect&&h&&!h.isLoading){var m=this.entityType.keyProperties,g=m.map(function(n){return n===e?t:this.getProperty(n.name)},this),v=new vt(this.entityType,g);if(h.findEntityByKey(v))throw new Error("An entity with this key is already in the cache: "+v.toString());var S=this.entityAspect.getKey(),w=h._findEntityGroup(this.entityType);w._replaceKey(S,v)}var E=e.relatedNavigationProperty;if(E&&h)null!=t?(o=new vt(E.entityType,[t]),s=h.findEntityByKey(o),s?this.setProperty(E.name,s):h._unattachedChildrenMap.addChild(o,E,this)):this.setProperty(E.name,null);else if(e.inverseNavigationProperty&&h&&!h._inKeyFixup){var P=e.inverseNavigationProperty;if(null!=r&&(o=new vt(P.parentType,[r]),s=h.findEntityByKey(o)))if(P.isScalar)s.setProperty(P.name,null);else{var T=s.getProperty(P.name);T.splice(T.indexOf(this),1)}null!=t&&(o=new vt(P.parentType,[t]),s=h.findEntityByKey(o),s?P.isScalar?s.setProperty(P.name,this):s.getProperty(P.name).push(this):h._unattachedChildrenMap.addChild(o,P,this))}if(n(t),h&&!h.isLoading&&(c.entityState.isUnchanged()&&!e.isUnmapped&&c.setModified(),h.validationOptions.validateOnPropertyChange&&c._validateProperty(t,{entity:f,property:e,propertyName:y,oldValue:r})),e.isPartOfKey&&!this.complexAspect){var _=this.entityType.keyProperties.indexOf(e);this.entityType.navigationProperties.forEach(function(e){var n=e.inverse,r=n?n.foreignKeyNames:e.invForeignKeyNames;if(0!==r.length){var a=u.getProperty(e.name),i=r[_];if(e.isScalar){if(!a)return;a.setProperty(i,t)}else a.forEach(function(e){e.setProperty(i,t)})}}),c.getKey(!0)}}else{if(!e.isScalar)throw new Error("Nonscalar navigation properties are readonly - entities can be added or removed but the collection may not be changed.");var N=e.inverse;if(null!=t){var b=t.entityAspect;if(h){if(b.entityState.isDetached())h.isLoading||h.attachEntity(t,St.Added);else if(b.entityManager!==h)throw new Error("An Entity cannot be attached to an entity in another EntityManager. One of the two entities must be detached first.")}else b&&b.entityManager&&(h=b.entityManager,h.isLoading||h.attachEntity(c.entity,St.Added))}if(N)if(N.isScalar)null!=r&&r.setProperty(N.name,null),null!=t&&t.setProperty(N.name,this);else{if(null!=r){var O=r.getProperty(N.name),C=O.indexOf(this);-1!==C&&O.splice(C,1)}if(null!=t){var A=t.getProperty(N.name);A.push(this)}}else if(e.invForeignKeyNames&&h&&!h._inKeyFixup){var x=e.invForeignKeyNames;if(null!=t){var M=this.entityAspect.getKey().values;x.forEach(function(e,n){t.setProperty(e,M[n])})}else null!=r&&x.forEach(function(e){var t=r.entityType.getProperty(e);t.isPartOfKey||r.setProperty(e,null)})}if(n(t),h&&!h.isLoading&&(c.entityState.isUnchanged()&&!e.isUnmapped&&c.setModified(),h.validationOptions.validateOnPropertyChange&&c._validateProperty(t,{entity:this,property:e,propertyName:y,oldValue:r})),e.relatedDataProperties&&!c.entityState.isDeleted()){var k=e.entityType.keyProperties;k.forEach(function(n,r){var a=e.relatedDataProperties[r];if(t||!a.isPartOfKey){var i=t?t.getProperty(n.name):a.defaultValue;u.setProperty(a.name,i)}})}}var I={entity:f,property:e,propertyName:y,oldValue:r,newValue:t};h?h.isLoading||h.isRejectingChanges||(c.propertyChanged.publish(I),h.entityChanged.publish({entityAction:dt.PropertyChange,entity:f,args:I})):c.propertyChanged.publish(I)}finally{l.pop()}}}function R(e){return e.indexOf(":#")>=0}function q(e,t){return e+":#"+t}function L(e,t,n){if(t)if(Array.isArray(t))t.forEach(e.addProperty.bind(e));else{if("object"!=typeof t)throw new Error("The 'dataProperties' or 'navigationProperties' values must be either an array of data/nav properties or an object where each property defines a data/nav property");for(var r in t)if(et(t,r)){var a=t[r];a.name=r;var i=new n(a);e.addProperty(i)}}}function B(e,t){var n;if(n=Array.isArray(t)?t:t.split("."),1===n.length)return e.getProperty(t);for(var r=e,a=0;a<n.length&&(r=r.getProperty(n[a]),null!=r);a++);return r}function U(e){return e&&e.isDate?function(e){return e&&e.getTime()}:e===Pt.Time?function(e){return e&&b(e)}:function(e){return e}}function G(e,t){var n=[],r=[],a=[],i=e.dataService.serviceName,o=e.entityManager,s=o.helper,u=0;return t.entities.forEach(function(e){var t=e.entityAspect;u+=1;var p={headers:{"Content-ID":u,DataServiceVersion:"2.0"}};if(a[u]=e,t.entityState.isAdded())p.requestUri=e.entityType.defaultResourceName,p.method="POST",p.data=s.unwrapInstance(e,!0),r[u]=t.getKey();else if(t.entityState.isModified())$(p,t,i),p.method="MERGE",p.data=s.unwrapChangedValues(e,o.metadataStore,!0);else{if(!t.entityState.isDeleted())return;$(p,t,i),p.method="DELETE"}n.push(p)}),e.contentKeys=a,e.tempKeys=r,{__batchRequests:[{__changeRequests:n}]}}function $(e,t,n){var r=t.extraMetadata,a=r.uri;D(a,n)&&(a=a.substring(n.length)),e.requestUri=a,r.etag&&(e.headers["If-Match"]=r.etag)}function z(e,t){var n=new Error,r=e.response;if(n.message=r.statusText,n.statusText=r.statusText,n.status=r.statusCode,t&&(n.url=t),n.body=r.body,r.body){var a;try{var i=JSON.parse(r.body);n.body=i;var o="";do a=i.error||i.innererror,a||(o+=Q(i)),a=a||i.internalexception,i=a||i;while(a);o.length>0&&(n.message=o)}catch(s){}}return n}function Q(e){var t=e.message;return null==t?"":("string"==typeof t?t:t.value)+"; "}function J(e){var t=e.entityType||e.complexType;t.getProperties().forEach(function(t){var n=t.name;e[n]||Object.defineProperty(e,n,X(t))})}function H(e){var t=Object.getPrototypeOf(e);e._backingStore||(e._backingStore={});var n=t.entityType||t.complexType;return n.getProperties().forEach(function(t){var n=t.name;if(e.hasOwnProperty(n)){var r=e[n];delete e[n],e[n]=r}}),e._backingStore}function X(e){var t=e.name,n=function(e){return function(){return 0==arguments.length?e[t]:void(e[t]=arguments[0])}};return{get:function(){var e=this._backingStore;if(e||(this._pendingSets.process(),e=this._backingStore))return e[t]},set:function(r){var a=this._backingStore;if(!a)return void this._pendingSets.schedule(this,t,r);var i=n(a);this._$interceptor?this._$interceptor(e,r,i):i(r)},enumerable:!0,configurable:!0}}function W(e){e._koObj._suppressBreeze=!0}function Y(e){var t=e.array._koObj;t._suppressBreeze?t._suppressBreeze=!1:t.valueHasMutated()}var Z={version:"1.3.6",metadataVersion:"1.0.5"};Z.entityModel=Z,Z.entityTracking_backingStore="backingStore",Z.entityTracking_ko="ko",Z.entityTracking_backbone="backbone",Z.remoteAccess_odata="odata",Z.remoteAccess_webApi="webApi";var et=K(Object.prototype.hasOwnProperty),tt=K(Array.prototype.slice);Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var nt={};nt.objectForEach=n,nt.extend=u,nt.propEq=i,nt.pluck=o,nt.arrayEquals=v,nt.arrayFirst=h,nt.arrayIndexOf=d,nt.arrayRemoveItem=m,nt.arrayZip=g,nt.requireLib=w,nt.using=P,nt.memoize=_,nt.getUuid=N,nt.durationToSeconds=b,nt.isDate=C,nt.isGuid=x,nt.isDuration=M,nt.isFunction=A,nt.isEmpty=k,nt.isNumeric=I,nt.stringStartsWith=D,nt.stringEndsWith=V,nt.formatString=F,nt.parent=Z,Z.core=nt;var rt=function(){function e(e,t){return null==t?!1:"string"==typeof t&&t.length>0}function t(e,t){return null==t?!1:typeof t===e.typeName?!0:!1}function n(e,t){return null==t?!1:t instanceof e.type}function r(e,t){return null==t?!1:void 0!==t[e.propertyName]}function a(e,t){return null==t?!1:e.enumType.contains(t)}function i(e,t){return e.allowNull?void 0!==t:null!=t}function o(e,t){if(null==t)return!0;var n=e.prevContext;return n?n.fn(n,t):!0}function s(e,t){var n=e.prevContext,r=n?" or it "+y(n,t):"";return"is optional"+r}function p(e,t){if(!Array.isArray(t))return!1;if(e.mustNotBeEmpty&&0===t.length)return!1;var n=e.prevContext;return n?t.every(function(e){return n.fn(n,e)}):!0}function c(e,t){var n=e.mustNotBeEmpty?"a nonEmpty array":"an array",r=e.prevContext,a=r?" where each element "+y(r,t):"";return" must be "+n+a}function y(e,t){var n=e.msg;return"function"==typeof n&&(n=n(e,t)),n}function l(e,t){if(e._context){for(var n=e._context;null!=n.prevContext;)n=n.prevContext;if(null===n.prevContext)return n.prevContext=t,e;if(null!==t.prevContext)throw new Error("Illegal construction - use 'or' to combine checks");t.prevContext=e._context}return f(e,t)}function f(e,t){return e._contexts[e._contexts.length-1]=t,e._context=t,e}function h(e){var t=e._contexts;return null==t[t.length-1]&&t.pop(),0===t.length?void 0:t.some(function(t){return t.fn(t,e.v)})}function d(e,t){throw new Error(F("Error configuring an instance of '%1'. %2",e&&e._$typeName||"object",t))}var m=function(e,t){this.v=e,this.name=t,this._contexts=[null]},g=m.prototype;return g.isObject=function(){return this.isTypeOf("object")},g.isBoolean=function(){return this.isTypeOf("boolean")},g.isString=function(){return this.isTypeOf("string")},g.isNonEmptyString=function(){return l(this,{fn:e,msg:"must be a nonEmpty string"})},g.isNumber=function(){return this.isTypeOf("number")},g.isFunction=function(){return this.isTypeOf("function")},g.isTypeOf=function(e){return l(this,{fn:t,typeName:e,msg:F("must be a '%1'",e)})},g.isInstanceOf=function(e,t){return t=t||e.prototype._$typeName,l(this,{fn:n,type:e,typeName:t,msg:F("must be an instance of '%1'",t)})},g.hasProperty=function(e){return l(this,{fn:r,propertyName:e,msg:F("must have a '%1' property ",e)})},g.isEnumOf=function(e){return l(this,{fn:a,enumType:e,msg:F("must be an instance of the '%1' enumeration",e.name)})},g.isRequired=function(e){return l(this,{fn:i,allowNull:e,msg:"is required"})},g.isOptional=function(){var e={fn:o,prevContext:null,msg:s};return l(this,e)},g.isNonEmptyArray=function(){return this.isArray(!0)},g.isArray=function(e){var t={fn:p,mustNotBeEmpty:e,prevContext:null,msg:c};return l(this,t)},g.or=function(){return this._contexts.push(null),this._context=null,this},g.check=function(e){var t=h(this);if(void 0!==t){if(!t)throw new Error(this.getMessage());return void 0!==this.v?this.v:e}},g._addContext=function(e){return l(this,e)},g.getMessage=function(){var e=this,t=this._contexts.map(function(t){return y(t,e.v)}).join(", or it ");return F(this.MESSAGE_PREFIX,this.name)+" "+t},g.withDefault=function(e){return this.defaultValue=e,this},g.whereParam=function(e){return this.parent.whereParam(e)},g.applyAll=function(e,t,n){var r=e._$typeName;n=n||r&&this.parent.config._$typeName===r;var a=u({},this.parent.config);if(this.parent.params.forEach(function(r){n||delete a[r.name];try{r.check()}catch(i){d(e,i.message)}!t&&r._applyOne(e)}),!n)for(var i in a)void 0!==a[i]&&d(e,F("Unknown property: '%1'.",i))},g._applyOne=function(e){void 0!==this.v?e[this.name]=this.v:void 0!==this.defaultValue&&(e[this.name]=this.defaultValue)},g.MESSAGE_PREFIX="The '%1' parameter ",m}(),at=function(e,t){return new rt(e,t)},it=function(){var e=function(e){if("object"!=typeof e)throw new Error("Configuration parameter should be an object, instead it is a: "+typeof e);this.config=e,this.params=[]},t=e.prototype;return t.whereParam=function(e){var t=new rt(this.config[e],e);return t.parent=this,this.params.push(t),t},e}(),ot=function(e){return new it(e)};nt.Param=rt,nt.assertParam=at,nt.assertConfig=ot;var st=function(){function e(){}var t=function(t,n){this.name=t;var r=new e(n);r.parentEnum=this,this._symbolPrototype=r,n&&Object.keys(n).forEach(function(e){r[e]=n[e]})},n=t.prototype;return t.isSymbol=function(t){return t instanceof e},n.fromName=function(e){return this[e]},n.addSymbol=function(e){var t=Object.create(this._symbolPrototype);return e&&Object.keys(e).forEach(function(n){t[n]=e[n]}),setTimeout(function(){t.getName()},0),t},n.seal=function(){this.getSymbols().forEach(function(e){return e.getName()})},n.getSymbols=function(){return this.getNames().map(function(e){return this[e]},this)},n.getNames=function(){var e=[];for(var t in this)this.hasOwnProperty(t)&&("name"===t||"_"===t.substr(0,1)||A(this[t])||e.push(t));return e},n.contains=function(t){return t instanceof e?this[t.getName()]===t:!1},e.prototype.getName=function(){if(!this.name){var e=this;this.name=h(this.parentEnum.getNames(),function(t){return e.parentEnum[t]===e})}return this.name},e.prototype.toString=function(){return this.getName()},e.prototype.toJSON=function(){return{_$typeName:this.parentEnum.name,name:this.name}},t}();nt.Enum=st;var ut=function(){function e(e,n,r){var a=e._subscribers;return a?void a.forEach(function(a){try{a.callback(n)}catch(i){i.context="unable to publish on topic: "+e.name,r?r(i):e._defaultErrorCallback?e._defaultErrorCallback(i):t(i)}}):!0}function t(){}var n={},r=1,a=function(e,t,r){at(e,"eventName").isNonEmptyString().check(),at(t,"publisher").isObject().check(),this.name=e,n[e]=!0,this.publisher=t,r&&(this._defaultErrorCallback=r)},i=a.prototype;return i.publish=function(t,n,r){return a._isEnabled(this.name,this.publisher)?(n===!0?setTimeout(e,0,this,t,r):e(this,t,r),!0):!1},i.publishAsync=function(e,t){this.publish(e,!0,t)},i.subscribe=function(e){this._subscribers||(this._subscribers=[]);var t=r;return this._subscribers.push({unsubKey:t,callback:e}),++r,t},i.unsubscribe=function(e){if(!this._subscribers)return!1;var t=this._subscribers,n=d(t,function(t){return t.unsubKey===e});return-1!==n?(t.splice(n,1),0===t.length&&(this._subscribers=null),!0):!1},i.clear=function(){this._subscribers=null},a.bubbleEvent=function(e,t){e._getEventParent=t},a.enable=function(e,t,n){at(e,"eventName").isNonEmptyString().check(),at(t,"obj").isObject().check(),at(n,"isEnabled").isBoolean().isOptional().or().isFunction().check(),t._$eventMap||(t._$eventMap={}),t._$eventMap[e]=n},a.isEnabled=function(e,t){if(at(e,"eventName").isNonEmptyString().check(),at(t,"obj").isObject().check(),!t._getEventParent)throw new Error("This object does not support event enabling/disabling");return a._isEnabled(t,e)},a._isEnabled=function(e,t){var n=null,r=t._$eventMap;if(r&&(n=r[e]),null!=n)return"function"==typeof n?n(t):!!n;var i=t._getEventParent&&t._getEventParent();return i?a._isEnabled(e,i):!0},a}();nt.Event=ut;var pt=function(){function e(e,t,r){var a=t.defaultInstance;return a||(a=new t.ctor,t.defaultInstance=a,a._$impl=t),a.initialize(),r&&(e.defaultInstance=a),n.interfaceInitialized.publish({interfaceName:e.name,instance:a,isDefault:!0}),a.checkForRecomposition&&n.interfaceInitialized.subscribe(function(e){a.checkForRecomposition(e)}),a}function t(e){var t=e.toLowerCase(),a=r(n.interfaceRegistry||{},function(e){return e.toLowerCase()===t});if(!a)throw new Error("Unknown interface name: "+e);return a.value}var n={};n.functionRegistry={},n.typeRegistry={},n.objectRegistry={},n.interfaceInitialized=new ut("interfaceInitialized",n);var i=function(e){this.name=e,this.defaultInstance=null,this._implMap={}};return i.prototype.registerCtor=function(e,t){this._implMap[e.toLowerCase()]={ctor:t,defaultInstance:null}},i.prototype.getImpl=function(e){return this._implMap[e.toLowerCase()]},i.prototype.getFirstImpl=function(){var e=r(this._implMap,function(){return!0});return e?e.value:null},n.interfaceRegistry={ajax:new i("ajax"),modelLibrary:new i("modelLibrary"),dataService:new i("dataService")},n.interfaceRegistry.modelLibrary.getDefaultInstance=function(){if(!this.defaultInstance)throw new Error("Unable to locate the default implementation of the '"+this.name+"' interface.  Possible options are 'ko', 'backingStore' or 'backbone'. See the breeze.config.initializeAdapterInstances method.");return this.defaultInstance},n.setProperties=function(e){ot(e).whereParam("remoteAccessImplementation").isOptional().whereParam("trackingImplementation").isOptional().whereParam("ajaxImplementation").isOptional().applyAll(e),e.remoteAccessImplementation&&n.initializeAdapterInstance("dataService",e.remoteAccessImplementation),e.trackingImplementation&&n.initializeAdapterInstance("modelLibrary",e.trackingImplementation),e.ajaxImplementation&&n.initializeAdapterInstance("ajax",e.ajaxImplementation)},n.registerAdapter=function(e,n){at(e,"interfaceName").isNonEmptyString().check(),at(n,"adapterCtor").isFunction().check();var r=new n,a=r.name;if(!a)throw new Error("Unable to locate a 'name' property on the constructor passed into the 'registerAdapter' call.");var i=t(e);i.registerCtor(a,n)},n.getAdapter=function(e,n){var r=t(e);if(n){var a=r.getImpl(n);return a?a.ctor:null}return r.defaultInstance?r.defaultInstance._$impl.ctor:null},n.initializeAdapterInstances=function(e){return ot(e).whereParam("dataService").isOptional().whereParam("modelLibrary").isOptional().whereParam("ajax").isOptional().applyAll(this,!1),a(e,n.initializeAdapterInstance)},n.initializeAdapterInstance=function(n,r,a){a=void 0===a?!0:a,at(n,"interfaceName").isNonEmptyString().check(),at(r,"adapterName").isNonEmptyString().check(),at(a,"isDefault").isBoolean().check();var i=t(n),o=i.getImpl(r);if(!o)throw new Error("Unregistered adapter.  Interface: "+n+" AdapterName: "+r);return e(i,o,a)},n.getAdapterInstance=function(n,r){var a,i=t(n);return r&&""!==r?(a=i.getImpl(r),a?a.defaultInstance:null):i.defaultInstance?i.defaultInstance:(a=i.getFirstImpl(),a.defaultInstance?a.defaultInstance:e(i,a,!0))},n.registerFunction=function(e,t){at(e,"fn").isFunction().check(),at(t,"fnName").isString().check(),e.prototype._$fnName=t,n.functionRegistry[t]=e},n._storeObject=function(e,t,r){var a=("string"==typeof t?t:t.prototype._$typeName)+"."+r;n.objectRegistry[a]=e},n._fetchObject=function(e,t){if(!t)return void 0;var r=("string"==typeof e?e:e.prototype._$typeName)+"."+t,a=n.objectRegistry[r];if(!a)throw new Error("Unable to locate a registered object by the name: "+r);return a},n.registerType=function(e,t){at(e,"ctor").isFunction().check(),at(t,"typeName").isString().check(),e.prototype._$typeName=t,n.typeRegistry[t]=e},n.stringifyPad="  ",n}(),ct=pt.interfaceRegistry.modelLibrary;nt.config=pt,Z.config=pt;var yt=function(){function e(e){var t=e.getEntityAspect();t.entityState.isUnchanged()&&t.setModified(),t.entityState.isModified()&&!e._origValues&&(e._origValues=e.slice(0))}function t(e,t){e._processAdds(t),r(e,"arrayChanged",{array:e,added:t})}function n(e,t){e._processRemoves(t),r(e,"arrayChanged",{array:e,removed:t})}function r(e,t,n){var r=e._getPendingPubs();r?e._pendingArgs?a(e._pendingArgs,n):(e._pendingArgs=n,r.push(function(){e[t].publish(e._pendingArgs),e._pendingArgs=null})):e[t].publish(n)}function a(e,t){for(var n in t)if("array"!==n&&e.hasOwnProperty(n)){var r=t[n],a=e[n];if(a){if(!Array.isArray(a))throw new Error("Cannot combine non array args");Array.prototype.push.apply(a,r)}else e[n]=r}}function i(e,t,n){e.parent=t,e.parentProperty=n}var o={};return o.push=function(){if(this._inProgress)return-1;var e=this._getGoodAdds(tt(arguments));if(!e.length)return this.length;this._beforeChange();var n=Array.prototype.push.apply(this,e);return t(this,e),n},o._push=function(){if(this._inProgress)return-1;var e=tt(arguments);this._beforeChange();var n=Array.prototype.push.apply(this,e);return t(this,e),n},o.unshift=function(){var e=this._getGoodAdds(tt(arguments));if(!e.length)return this.length;this._beforeChange();var n=Array.prototype.unshift.apply(this,e);return t(this,tt(e)),n},o.pop=function(){this._beforeChange();var e=Array.prototype.pop.apply(this);return n(this,[e]),e},o.shift=function(){this._beforeChange();var e=Array.prototype.shift.apply(this);return n(this,[e]),e},o.splice=function(){var e=this._getGoodAdds(tt(arguments,2)),r=tt(arguments,0,2).concat(e);this._beforeChange();var a=Array.prototype.splice.apply(this,r);return n(this,a),e.length&&t(this,e),a},o.getEntityAspect=function(){return this.parent.entityAspect||this.parent.complexAspect.getEntityAspect()},o._getEventParent=function(){return this.getEntityAspect()},o._getPendingPubs=function(){var e=this.getEntityAspect().entityManager;return e&&e._pendingPubs},o._beforeChange=function(){},{mixin:o,publish:r,updateEntityState:e,initializeParent:i}}(),lt=function(){function e(e,t,n){return t?e.replace(/%([^%]+)%/g,function(e,r){var a;return a=n?t.hasOwnProperty(r)?t[r]:"":t[r],a?A(a)?a(t):a:""}):e}function t(e,t,n,r){return y.messageTemplates[e]=F("'%displayName%' must be an integer between the values of %1 and %2",t,n),function(){var a=function(e,r){return null==e?!0:("string"==typeof e&&r&&r.allowString&&(e=parseInt(e,0)),"number"!=typeof e||isNaN(e)||Math.floor(e)!==e?!1:null!=t&&t>e?!1:null!=n&&e>n?!1:!0)};return new y(e,a,r)}}var r=-32768,a=32767,i=-2147483648,o=2147483647,s=0,p=255,c={displayName:function(e){return e.property?e.property.displayName||e.propertyName||e.property.name:"Value"}},y=function(e,t,n){this._baseContext=n||{},this._baseContext.name=e,n=u(Object.create(c),this._baseContext),n.messageTemplate=n.messageTemplate||y.messageTemplates[e],this.name=e,this.valFn=t,this.context=n},l=y.prototype;return l._$typeName="Validator",l.validate=function(e,t){var n;return n=t?u(Object.create(this.context),t):this.context,this.currentContext=n,this.valFn(e,n)?null:(n.value=e,new ft(this,n,this.getMessage()))},l.getMessage=function(){try{var t=this.currentContext,n=t.message;return n?"function"==typeof n?n(t):n:t.messageTemplate?e(t.messageTemplate,t):"invalid value: "+this.name||"{unnamed validator}"}catch(r){return"Unable to format error message"+r.toString()}},l.toJSON=function(){return this._baseContext},y.fromJSON=function(e){var t="Validator."+e.name,n=pt.functionRegistry[t];if(!n)throw new Error("Unable to locate a validator named:"+e.name);return n(e)},y.register=function(e){pt.registerFunction(function(){return e},"Validator."+e.name)},y.registerFactory=function(e,t){pt.registerFunction(e,"Validator."+t)},y.messageTemplates={required:"'%displayName%' is required",date:"'%displayName%' must be a date",string:"'%displayName%' must be a string",bool:"'%displayName%' must be a 'true' or 'false' value",guid:"'%displayName%' must be a GUID",duration:"'%displayName%' must be a ISO8601 duration string, such as 'P3H24M60S'",number:"'%displayName%' must be a number",integer:"'%displayName%' must be an integer",integerRange:"'%displayName%' must be an integer between the values of %minValue% and %maxValue%",maxLength:"'%displayName%' must be a string with less than %maxLength% characters",stringLength:"'%displayName%' must be a string with between %minLength% and %maxLength% characters"},y.required=function(){var e=function(e,t){return"string"==typeof e?t&&t.allowEmptyStrings?!0:e.length>0:null!=e};return new y("required",e)},y.maxLength=function(e){var t=function(e,t){return null==e?!0:"string"!=typeof e?!1:e.length<=t.maxLength};return new y("maxLength",t,e)},y.stringLength=function(e){var t=function(e,t){return null==e?!0:"string"!=typeof e?!1:null!=t.minLength&&e.length<t.minLength?!1:null!=t.maxLength&&e.length>t.maxLength?!1:!0};return new y("stringLength",t,e)},y.string=function(){var e=function(e){return null==e?!0:"string"==typeof e};return new y("string",e)},y.guid=function(){var e=function(e){return null==e?!0:x(e)};return new y("guid",e)},y.duration=function(){var e=function(e){return null==e?!0:M(e)};return new y("duration",e)},y.number=y.double=y.single=function(e){var t=function(e,t){return null==e?!0:("string"==typeof e&&t&&t.allowString&&(e=parseInt(e,10)),"number"==typeof e&&!isNaN(e))};return new y("number",t,e)},y.integer=y.int64=function(e){var t=function(e,t){return null==e?!0:("string"==typeof e&&t&&t.allowString&&(e=parseInt(e,10)),"number"==typeof e&&!isNaN(e)&&Math.floor(e)===e)};return new y("integer",t,e)},y.int32=function(e){return t("int32",i,o,e)()},y.int16=function(e){return t("int16",r,a,e)()},y.byte=function(e){return t("byte",s,p,e)()},y.bool=function(){var e=function(e){return null==e?!0:e===!0||e===!1};return new y("bool",e)},y.none=function(){var e=function(){return!0};return new y("none",e)},y.date=function(){var e=function(e){if(null==e)return!0;if("string"!=typeof e)return C(e);try{return!isNaN(Date.parse(e))}catch(t){return!1}};return new y("date",e)},n(y,function(e,t){"function"==typeof t&&"fromJSON"!==e&&"register"!==e&&"registerFactory"!==e&&pt.registerFunction(t,"Validator."+e)}),y}(),ft=function(){var e=function(e,t,n){at(e,"validator").isString().or().isInstanceOf(lt).check(),this.validator=e,t=t||{},this.context=t,this.property=t.property,this.property&&(this.propertyName=t.propertyName||t.property.name),this.errorMessage=n,this.key=ft.getKey(e,this.propertyName)};return e.getKey=function(e,t){return(t||"")+":"+e.name},e}();Z.Validator=lt,Z.ValidationError=ft;var ht=function(){function e(e,t){return t&&ot(t).whereParam("validateOnAttach").isBoolean().isOptional().whereParam("validateOnSave").isBoolean().isOptional().whereParam("validateOnQuery").isBoolean().isOptional().whereParam("validateOnPropertyChange").isBoolean().isOptional().applyAll(e),e}var t=function(t){e(this,t)},n=t.prototype;return n._$typeName="ValidationOptions",n.using=function(t){if(!t)return this;var n=new ht(this);return e(n,t),n},n.setAsDefault=function(){return c(this,t)},t.defaultInstance=new t({validateOnAttach:!0,validateOnSave:!0,validateOnQuery:!1,validateOnPropertyChange:!0}),t}();Z.ValidationOptions=ht,Z.makeComplexArray=function(){function e(e,t){return t.filter(function(t){return t.parent!==e.parent})}function t(e,t){t.forEach(function(t){if(null!=t.parent)throw new Error("The complexObject is already attached. Either clone it or remove it from its current owner");a(t,e)})}function n(e,t){t.forEach(function(t){r(t,e)})}function r(e,t){var n=e.complexAspect;return n.parent!==t.parent?null:(n.parent=null,n.parentProperty=null,n)}function a(e,t){var n=e.complexAspect;return n.parent===t.parent?null:(n.parent=t.parent,n.parentProperty=t.parentProperty,n)}function i(e,t,n){return yt.initializeParent(e,t,n),e.arrayChanged=new ut("arrayChanged",e),u(e,yt.mixin),u(e,o)}var o={};return o._getGoodAdds=function(t){return e(this,t)},o._beforeChange=function(){yt.updateEntityState(this)},o._processAdds=function(e){t(this,e)},o._processRemoves=function(e){n(this,e)},o._rejectChanges=function(){if(this._origValues){var e=this;this.forEach(function(t){r(t,e)}),this.length=0,this._origValues.forEach(function(t){e.push(t)}),Array.prototype.push.apply(this,this._origValues)}},o._acceptChanges=function(){this._origValues=null},i}();var dt=function(){var e={isAttach:function(){return!!this.isAttach},isDetach:function(){return!!this.isDetach},isModification:function(){return!!this.isModification}},t=new st("EntityAction",e);return t.Attach=t.addSymbol({isAttach:!0}),t.AttachOnQuery=t.addSymbol({isAttach:!0}),t.AttachOnImport=t.addSymbol({isAttach:!0}),t.Detach=t.addSymbol({isDetach:!0}),t.MergeOnQuery=t.addSymbol({isModification:!0}),t.MergeOnImport=t.addSymbol({isModification:!0}),t.MergeOnSave=t.addSymbol({isModification:!0}),t.PropertyChange=t.addSymbol({isModification:!0}),t.EntityStateChange=t.addSymbol(),t.AcceptChanges=t.addSymbol(),t.RejectChanges=t.addSymbol({isModification:!0}),t.Clear=t.addSymbol({isDetach:!0}),t.seal(),t
}();Z.EntityAction=dt;var mt=function(){function e(t){var n=t.entityAspect||t.complexAspect,r=t.entityType||t.complexType,a=n.originalValues;for(var i in a)t.setProperty(i,a[i]);r.complexProperties.forEach(function(n){var r=t.getProperty(n.name);n.isScalar?e(r):(r._rejectChanges(),r.forEach(function(t){e(t)}))})}function t(e){var n=e.entityAspect||e.complexAspect;n.originalValues={};var r=e.entityType||e.complexType;r.complexProperties.forEach(function(n){var r=e.getProperty(n.name);n.isScalar?t(r):(r._acceptChanges(),r.forEach(function(e){t(e)}))})}function r(e){var t=!0,n=e.entityType||e.complexType,a=e.entityAspect||e.complexAspect,i=e.entityAspect||e.complexAspect.getEntityAspect();return n.getProperties().forEach(function(n){var o=e.getProperty(n.name),s=a.getPropertyPath(n.name);if(n.validators.length>0){var u={entity:i.entity,property:n,propertyName:s};t=i._validateProperty(o,u)&&t}n.isComplexProperty&&n.isScalar&&(t=r(o)&&t)}),n.validators.forEach(function(e){t=u(i,e,a.entity)&&t}),t}function a(e,t){var n=t.isDeleted();n?i(e,!0):P(e.entityAspect.entityManager,"isLoading",!0,function(){i(e,!1)})}function i(e,t){e.entityType.navigationProperties.forEach(function(n){var r=n.inverse;if(r){var a=e.getProperty(n.name);if(n.isScalar){if(a){if(r.isScalar)o(a,r,t);else{var i=a.getProperty(r.name);i.length&&m(i,e)}e.setProperty(n.name,null)}}else a.slice(0).forEach(function(e){r.isScalar&&o(e,r,t)}),a.length=0}})}function o(e,t,n){if(n)e.setProperty(t.name,null);else{var r=(e.entityAspect.entityManager,t.foreignKeyNames);if(r)var a=r.map(function(t){return e.getProperty(t)});e.setProperty(t.name,null),r&&r.forEach(function(t,n){e.setProperty(t,a[n])})}}function u(e,t,n,r){var a=t.validate(n,r);return a?(e._addValidationError(a),!1):(e._removeValidationError(t,r?r.propertyName:null),!0)}var p=function(e){if(null===e){var t=mt._nullInstance;if(t)return t;mt._nullInstance=this}else{if(void 0===e)throw new Error("The EntityAspect ctor requires an entity as its only argument.");if(e.entityAspect)return e.entityAspect}if(!(this instanceof mt))return new mt(e);if(this.entity=e,this.entityGroup=null,this.entityManager=null,this.entityState=St.Detached,this.isBeingSaved=!1,this.originalValues={},this.hasValidationErrors=!1,this._validationErrors={},this.validationErrorsChanged=new ut("validationErrorsChanged",this),this.propertyChanged=new ut("propertyChanged",this),null!=e){e.entityAspect=this;var n=e.entityType;if(!n){var r=e.prototype._$typeName;throw new Error(r?"Metadata for this entityType has not yet been resolved: "+r:"This entity is not registered as a valid EntityType")}var a=n.getEntityCtor();ct.getDefaultInstance().startTracking(e,a.prototype)}},c=p.prototype;return c._postInitialize=function(){var e=this.entity,t=e.entityType.getEntityCtor(),n=t._$initializationFn;n&&("string"==typeof n&&(n=e[n]),n(e))},ut.bubbleEvent(c,function(){return this.entityManager}),c.getKey=function(e){if(e=at(e,"forceRefresh").isBoolean().isOptional().check(!1),e||!this._entityKey){var t=this.entity.entityType,n=t.keyProperties,r=n.map(function(e){return this.entity.getProperty(e.name)},this);this._entityKey=new vt(t,r)}return this._entityKey},c.acceptChanges=function(){var e=this.entityManager;this.entityState.isDeleted()?e.detachEntity(this.entity):this.setUnchanged(),e.entityChanged.publish({entityAction:dt.AcceptChanges,entity:this.entity})},c.rejectChanges=function(){var t=this.entity,n=this.entityManager;P(n,"isRejectingChanges",!0,function(){e(t)}),this.entityState.isAdded()?(n.detachEntity(t),n._notifyStateChange(t,!1)):(this.entityState.isDeleted()&&this.entityManager._linkRelatedEntities(t),this.setUnchanged(),this.propertyChanged.publish({entity:t,propertyName:null}),this.entityManager.entityChanged.publish({entityAction:dt.RejectChanges,entity:t}))},c.getPropertyPath=function(e){return e},c.setUnchanged=function(){t(this.entity),delete this.hasTempKey,this.entityState=St.Unchanged,this.entityManager._notifyStateChange(this.entity,!1)},c.setModified=function(){this.entityState=St.Modified,this.entityManager._notifyStateChange(this.entity,!0)},c.setDeleted=function(){var e=this.entityManager,t=this.entity;this.entityState.isAdded()?(e.detachEntity(t),e._notifyStateChange(t,!1)):(this.entityState=St.Deleted,a(t,St.Deleted),e._notifyStateChange(t,!0))},c.setDetached=function(){var e=this.entityGroup;if(!e)return!1;var t=this.entity;return e.detachEntity(t),a(t,St.Detached),this.entityManager.entityChanged.publish({entityAction:dt.Detach,entity:t}),this._detach(),!0},c.loadNavigationProperty=function(e,t,n){var r=this.entity,a=r.entityType._checkNavProperty(e),i=It.fromEntityNavigation(r,a,t,n);return r.entityAspect.entityManager.executeQuery(i,t,n)},c.validateEntity=function(){var e=!0;return this._processValidationOpAndPublish(function(t){e=r(t.entity)}),e},c.validateProperty=function(e,t){var n=this.getPropertyValue(e);return n&&n.complexAspect?r(n):(t=t||{},t.entity=this.entity,"string"==typeof e?(t.property=this.entity.entityType.getProperty(e,!0),t.propertyName=e):(t.property=e,t.propertyName=e.name),this._validateProperty(n,t))},c.getValidationErrors=function(e){at(e,"property").isOptional().isEntityProperty().or().isString().check();var t=s(this._validationErrors);if(e){var n="string"==typeof e?e:e.name;t=t.filter(function(e){return e.property.name===n})}return t},c.addValidationError=function(e){at(e,"validationError").isInstanceOf(ft).check(),this._processValidationOpAndPublish(function(t){t._addValidationError(e)})},c.removeValidationError=function(e,t){at(e,"validator").isString().or().isInstanceOf(lt).check(),at(t,"property").isOptional().isEntityProperty().check(),this._processValidationOpAndPublish(function(n){n._removeValidationError(e,t&&t.name)})},c.clearValidationErrors=function(){this._processValidationOpAndPublish(function(e){n(e._validationErrors,function(t,n){n&&(delete e._validationErrors[t],e._pendingValidationResult.removed.push(n))}),e.hasValidationErrors=!k(this._validationErrors)})},c.getParentKey=function(e){var t=e.foreignKeyNames;if(0===t.length)return null;var n=this,r=t.map(function(e){return n.entity.getProperty(e)});return new vt(e.entityType,r)},c.getPropertyValue=function(e){at(e,"property").isString().or().isEntityProperty().check();var t;if("string"==typeof e){var n=e.trim().split("."),r=n.shift();for(t=this.entity,t=t.getProperty(r);n.length>0;)r=n.shift(),t=t.getProperty(r)}else{if(!(e.parentType instanceof Nt))throw new Error("The validateProperty method does not accept a 'property' parameter whose parentType is a ComplexType; Pass a 'property path' string as the 'property' parameter instead ");t=this.entity.getProperty(e.name)}return t},c._detach=function(){this.entityGroup=null,this.entityManager=null,this.entityState=St.Detached,this.originalValues={},this._validationErrors={},this.hasValidationErrors=!1,this.validationErrorsChanged.clear(),this.propertyChanged.clear()},c._validateProperty=function(e,t){var n=!0;return this._processValidationOpAndPublish(function(r){t.property.validators.forEach(function(a){n=n&&u(r,a,e,t)})}),n},c._processValidationOpAndPublish=function(e){if(this._pendingValidationResult)e(this);else try{this._pendingValidationResult={entity:this.entity,added:[],removed:[]},e(this),(this._pendingValidationResult.added.length>0||this._pendingValidationResult.removed.length>0)&&(this.validationErrorsChanged.publish(this._pendingValidationResult),this.entityManager.validationErrorsChanged.publish(this._pendingValidationResult))}finally{this._pendingValidationResult=void 0}},c._addValidationError=function(e){this._validationErrors[e.key]=e,this.hasValidationErrors=!0,this._pendingValidationResult.added.push(e)},c._removeValidationError=function(e,t){var n=ft.getKey(e,t),r=this._validationErrors[n];r&&(delete this._validationErrors[n],this.hasValidationErrors=!k(this._validationErrors),this._pendingValidationResult.removed.push(r))},p}(),gt=function(){var e=function(e,t,n){if(!e)throw new Error("The  ComplexAspect ctor requires an entity as its only argument.");if(e.complexAspect)return e.complexAspect;if(!(this instanceof gt))return new gt(e,t,n);this.complexObject=e,e.complexAspect=this,this.originalValues={},null!=t&&(this.parent=t,this.parentProperty=n);var r=e.complexType;if(!r){var a=e.prototype._$typeName;throw new Error(a?"Metadata for this complexType has not yet been resolved: "+a:"This entity is not registered as a valid ComplexType")}var i=r.getCtor();ct.getDefaultInstance().startTracking(e,i.prototype)},t=e.prototype;return t.getEntityAspect=function(){var e=this.parent;if(!e)return new mt(null);for(var t=e.entityAspect;e&&!t;)e=e.complexAspect&&e.complexAspect.parent,t=e&&e.entityAspect;return t||new mt(null)},t.getPropertyPath=function(e){var t=this.parent;if(!t)return null;var n=t.complexAspect||t.entityAspect;return n.getPropertyPath(this.parentProperty.name+"."+e)},t._postInitialize=function(){var e=this.complexObject,t=e.complexType.getCtor(),n=t._$initializationFn;n&&("string"==typeof n?e[n](e):t._$initializationFn(e))},e}();Z.EntityAspect=mt,Z.ComplexAspect=gt;var vt=function(){function e(e){return e.join(t)}var t=":::",n=function(t,n){at(t,"entityType").isInstanceOf(Nt).check();var r=t.getSelfAndSubtypes();r.length>1&&(this._subtypes=r.filter(function(e){return e.isAbstract===!1})),Array.isArray(n)||(n=tt(arguments,1)),this.entityType=t,t.keyProperties.forEach(function(e,t){e.dataType===Pt.Guid&&(n[t]=n[t]&&n[t].toLowerCase())}),this.values=n,this._keyInGroup=e(n)};n._$typeName="EntityKey";var r=n.prototype;return r.toJSON=function(){return{entityType:this.entityType.name,values:this.values}},n.fromJSON=function(e,t){var n=t._getEntityType(e.entityType,!0);return new vt(n,e.values)},r.equals=function(e){return e instanceof vt?this.entityType===e.entityType&&v(this.values,e.values):!1},r.toString=function(){return this.entityType.name+"-"+this._keyInGroup},n.equals=function(e,t){return e instanceof vt?e.equals(t):!1},r._isEmpty=function(){return 0===this.values.join("").length},n.createKeyString=e,n}();Z.EntityKey=vt;var St=function(){var e={isUnchanged:function(){return this===t.Unchanged},isAdded:function(){return this===t.Added},isModified:function(){return this===t.Modified},isDeleted:function(){return this===t.Deleted},isDetached:function(){return this===t.Detached},isUnchangedOrModified:function(){return this===t.Unchanged||this===t.Modified},isAddedModifiedOrDeleted:function(){return this===t.Added||this===t.Modified||this===t.Deleted}},t=new st("EntityState",e);return t.Unchanged=t.addSymbol(),t.Added=t.addSymbol(),t.Modified=t.addSymbol(),t.Deleted=t.addSymbol(),t.Detached=t.addSymbol(),t.seal(),t}();Z.EntityState=St,Z.makePrimitiveArray=function(){function e(e,n,r){return yt.initializeParent(e,n,r),e.arrayChanged=new ut("arrayChanged",e),u(e,yt.mixin),u(e,t)}var t={};return t._getGoodAdds=function(e){return e},t._beforeChange=function(){var e=this.getEntityAspect();e.entityState.isUnchanged()&&e.setModified(),e.entityState.isModified()&&!this._origValues&&(this._origValues=this.slice(0))},t._processAdds=function(){},t._processRemoves=function(){},t._rejectChanges=function(){this._origValues&&(this.length=0,Array.prototype.push.apply(this,this._origValues))},t._acceptChanges=function(){this._origValues=null},e}(),Z.makeRelationArray=function(){function e(e,t){var n=r(e,t);if(!n.length)return n;var a=e.parentEntity,i=a.entityAspect.entityManager;return i&&!i.isLoading&&n.forEach(function(t){if(t.entityAspect.entityState.isDetached()){e._inProgress=!0;try{i.attachEntity(t,St.Added)}finally{e._inProgress=!1}}}),n}function t(e,t){var n=e.parentEntity,r=e.navigationProperty,a=e._addsInProcess,i=r.inverse,o=a.length;try{t.forEach(function(e){if(a.push(e),i)e.setProperty(i.name,n);else{var t=n.entityType.keyProperties;r.invForeignKeyNames.forEach(function(r,a){e.setProperty(r,n.getProperty(t[a].name))})}})}finally{a.splice(o,t.length)}}function n(e,t){var n=e.navigationProperty.inverse;n&&t.forEach(function(e){e.setProperty(n.name,null)})}function r(e,t){var n,r=e.parentEntity,a=e.navigationProperty,i=a.inverse;if(i)n=t.filter(function(t){if(e._addsInProcess.indexOf(t)>=0)return!1;var n=t.getProperty(i.name);return n!==r});else{var o=a.invForeignKeyNames,s=r.entityType.keyProperties;n=t.filter(function(t){return e._addsInProcess.indexOf(t)>=0?!1:o.some(function(e,n){var a=s[n].name,i=r.getProperty(a),o=t.getProperty(e);return i!==o})})}return n}function a(e,t,n){return e.parentEntity=t,e.navigationProperty=n,e.arrayChanged=new ut("arrayChanged",e),e._addsInProcess=[],u(e,yt.mixin),u(e,i)}var i={};return i.load=function(e,t){var n=this.parentEntity,r=It.fromEntityNavigation(this.parentEntity,this.navigationProperty),a=n.entityAspect.entityManager;return a.executeQuery(r,e,t)},i._getEventParent=function(){return this.parentEntity.entityAspect},i._getPendingPubs=function(){var e=this.parentEntity.entityAspect.entityManager;return e&&e._pendingPubs},i._getGoodAdds=function(t){return e(this,t)},i._processAdds=function(e){t(this,e)},i._processRemoves=function(e){n(this,e)},a}();var wt=function(){function e(e,t){return t&&(ot(t).whereParam("serviceName").isOptional().whereParam("adapterName").isString().isOptional().whereParam("hasServerMetadata").isBoolean().isOptional().whereParam("jsonResultsAdapter").isInstanceOf(Et).isOptional().whereParam("useJsonp").isBoolean().isOptional().applyAll(e),e.serviceName=e.serviceName&&wt._normalizeServiceName(e.serviceName),e.adapterInstance=e.adapterName&&pt.getAdapterInstance("dataService",e.adapterName)),e}var t=function(t){e(this,t)},n=t.prototype;return n._$typeName="DataService",n.using=function(t){if(!t)return this;var n=new wt(this);return e(n,t)},t.resolve=function(e){e.push({hasServerMetadata:!0,useJsonp:!1});var t=new wt(l(e,["serviceName","adapterName","hasServerMetadata","jsonResultsAdapter","useJsonp"]));if(!t.serviceName)throw new Error("Unable to resolve a 'serviceName' for this dataService");return t.adapterInstance=t.adapterInstance||pt.getAdapterInstance("dataService",t.adapterName),t.jsonResultsAdapter=t.jsonResultsAdapter||t.adapterInstance.jsonResultsAdapter,t},t._normalizeServiceName=function(e){return e=e.trim(),"/"!==e.substr(-1)?e+"/":e},n.toJSON=function(){return y(this,{serviceName:null,adapterName:null,hasServerMetadata:null,jsonResultsAdapter:function(e){return e&&e.name},useJsonp:null})},t.fromJSON=function(e){return e.jsonResultsAdapter=pt._fetchObject(Et,e.jsonResultsAdapter),new wt(e)},n.makeUrl=function(e){var t=this.serviceName;return nt.stringEndsWith(t,"/")&&(t=t.substr(0,t.length-1)),e="/"+e,nt.stringEndsWith(t,e)||(t+=e),t},t}(),Et=function(){function e(e){return e.results}var t=function(t){if(1!==arguments.length)throw new Error("The JsonResultsAdapter ctor should be called with a single argument that is a configuration object.");ot(t).whereParam("name").isNonEmptyString().whereParam("extractResults").isFunction().isOptional().withDefault(e).whereParam("visitNode").isFunction().applyAll(this),pt._storeObject(this,n._$typeName,this.name)},n=t.prototype;return n._$typeName="JsonResultsAdapter",t}();Z.DataService=wt,Z.JsonResultsAdapter=Et;var Pt=function(){function e(e,t){throw e=F(e,t),new Error(e)}function t(e){switch(e){case T.String:return lt.string;case T.Int64:return lt.int64;case T.Int32:return lt.int32;case T.Int16:return lt.int16;case T.Decimal:return lt.number;case T.Double:return lt.number;case T.Single:return lt.number;case T.DateTime:return lt.date;case T.DateTimeOffset:return lt.date;case T.Boolean:return lt.bool;case T.Guid:return lt.guid;case T.Byte:return lt.byte;case T.Binary:return lt.none;case T.Time:return lt.duration;case T.Undefined:return lt.none}}var n={},r={stringPrefix:"K_",nextNumber:-1,nextNumberIncrement:-1},a=function(){return r.stringPrefix+i().toString()},i=function(){var e=r.nextNumber;return r.nextNumber+=r.nextNumberIncrement,e},o=function(){return N()},s=function(){return new Date},u=function(e){return null==e?e:e.toString()},p=function(e,t){if("string"===t){var n=e.trim();if(""===n)return null;var r=parseInt(n,10);return isNaN(r)?e:r}return"number"===t?Math.round(e):e},c=function(e,t){if("string"===t){var n=e.trim();if(""===n)return null;var r=parseFloat(n);return isNaN(r)?e:r}return e},y=function(e,t){var n;if("string"===t){var r=e.trim();return""===r?null:(n=new Date(Date.parse(r)),C(n)?n:e)}return"number"===t?(n=new Date(e),C(n)?n:e):e},l=function(e,t){if("string"===t){var n=e.trim().toLowerCase();return"false"===n||""===n?!1:"true"===n?!0:e}return e},f=function(e){return null==e?null:"'"+e+"'"},h=function(e){return null==e?null:"string"==typeof e?parseInt(e,10):e},d=function(e){return function(t){return null==t?null:("string"==typeof t&&(t=parseFloat(t)),t+e)}},m=function(t){if(null==t)return null;try{return"datetime'"+t.toISOString()+"'"}catch(n){e("'%1' is not a valid dateTime",t)}},g=function(t){if(null==t)return null;try{return"datetimeoffset'"+t.toISOString()+"'"}catch(n){e("'%1' is not a valid dateTime",t)}},v=function(t){return null==t?null:(M(t)||e("'%1' is not a valid ISO 8601 duration",t),"time'"+t+"'")},S=function(t){return null==t?null:(x(t)||e("'%1' is not a valid guid",t),"guid'"+t+"'")},w=function(e){return null==e?null:"string"==typeof e?"true"===e.trim().toLowerCase():!!e},E=function(e){return null==e?e:"binary'"+e+"'"},P=function(e){return e},T=new st("DataType",n);T.String=T.addSymbol({defaultValue:"",parse:u,fmtOData:f,getNext:a}),T.Int64=T.addSymbol({defaultValue:0,isNumeric:!0,isInteger:!0,quoteJsonOData:!0,parse:p,fmtOData:h,getNext:i}),T.Int32=T.addSymbol({defaultValue:0,isNumeric:!0,isInteger:!0,parse:p,fmtOData:h,getNext:i}),T.Int16=T.addSymbol({defaultValue:0,isNumeric:!0,isInteger:!0,parse:p,fmtOData:h,getNext:i}),T.Byte=T.addSymbol({defaultValue:0,isNumeric:!0,isInteger:!0,parse:p,fmtOData:h}),T.Decimal=T.addSymbol({defaultValue:0,isNumeric:!0,quoteJsonOData:!0,parse:c,fmtOData:d("m"),getNext:i}),T.Double=T.addSymbol({defaultValue:0,isNumeric:!0,parse:c,fmtOData:d("d"),getNext:i}),T.Single=T.addSymbol({defaultValue:0,isNumeric:!0,parse:c,fmtOData:d("f"),getNext:i}),T.DateTime=T.addSymbol({defaultValue:new Date(1900,0,1),isDate:!0,parse:y,fmtOData:m,getNext:s}),T.DateTimeOffset=T.addSymbol({defaultValue:new Date(1900,0,1),isDate:!0,parse:y,fmtOData:g,getNext:s}),T.Time=T.addSymbol({defaultValue:"PT0S",fmtOData:v}),T.Boolean=T.addSymbol({defaultValue:!1,parse:l,fmtOData:w}),T.Guid=T.addSymbol({defaultValue:"00000000-0000-0000-0000-000000000000",fmtOData:S,getNext:o}),T.Binary=T.addSymbol({defaultValue:null,fmtOData:E}),T.Undefined=T.addSymbol({defaultValue:void 0,fmtOData:P}),T.seal(),T.fromEdmDataType=function(e){var t=null,n=e.split(".");if(n.length>1){var r=n[1];t="image"===r?T.Byte:2===n.length?T.fromName(r)||T.Undefined:T.String}return t},T.fromValue=function(e){if(C(e))return T.DateTime;switch(typeof e){case"string":return x(e)?T.Guid:M(e)&&e.length>3?T.Time:T.String;case"boolean":return T.Boolean;case"number":return T.Int32}return T.Undefined};var _=/.\d{3}$/;return T.parseDateAsUTC=function(e){if("string"==typeof e){var t=_.test(e);e=t?e+"Z":e}return e=new Date(Date.parse(e))},T.parseDateFromServer=T.parseDateAsUTC,T.constants=r,T.getSymbols().forEach(function(e){e.validatorCtor=t(e)}),T}();Z.DataType=Pt;var t=w("Q","See https://github.com/kriskowal/q "),Tt=function(){function e(e){var t=[];for(var n in e){var r=e[n];n===r.name&&t.push(e[n])}return t}function n(e,t){var n=q(t.shortName,t.namespace),a=e._getEntityType(n,!0);if(a)return a;var i={shortName:t.shortName,namespace:t.namespace,isAbstract:t.isAbstract,autoGeneratedKeyType:At.fromName(t.autoGeneratedKeyType),defaultResourceName:t.defaultResourceName};if(a=t.isComplexType?new bt(i):new Nt(i),t.baseTypeName){a.baseTypeName=t.baseTypeName;var o=e._getEntityType(t.baseTypeName);o?r(e,t,a,o):S(e.deferredTypes,baseTypeName).push({json:t,stype:a})}else r(e,t,a,null);return a}function r(e,t,n,a){t.validators&&(n.validators=t.validators.map(lt.fromJSON)),a&&(n.baseEntityType=a,a.dataProperties.forEach(function(e){var t=new Ot(e);t.isInherited=!0,n.addProperty(t)}),a.navigationProperties.forEach(function(e){var t=new Ct(e);t.isInherited=!0,n.addProperty(t)})),t.dataProperties.forEach(function(e){n.addProperty(Ot.fromJSON(e))});var i=!t.isComplexType;i&&t.navigationProperties&&t.navigationProperties.forEach(function(e){n.addProperty(Ct.fromJSON(e))}),e.addEntityType(n);var o=e._deferredTypes,s=o[n.name];s&&(s.forEach(function(t){r(e,t.json,t.stype,n)}),delete o[n.name])}function i(e,t,n){if(R(t))return t;var r=e._shortNameMap[t];if(!r&&n)throw new Error("Unable to locate 'entityTypeName' of: "+t);return r}var o=0,s=function(e){e=e||{},ot(e).whereParam("namingConvention").isOptional().isInstanceOf(kt).withDefault(kt.defaultInstance).whereParam("localQueryComparisonOptions").isOptional().isInstanceOf(Mt).withDefault(Mt.defaultInstance).applyAll(this),this.dataServices=[],this._resourceEntityTypeMap={},this._structuralTypeMap={},this._shortNameMap={},this._ctorRegistry={},this._incompleteTypeMap={},this._incompleteComplexTypeMap={},this._id=o++},p=s.prototype;return p._$typeName="MetadataStore",s.ANONTYPE_PREFIX="_IB_",p.addDataService=function(e,t){at(e,"dataService").isInstanceOf(wt).check(),at(t,"shouldOverwrite").isBoolean().isOptional().check();var n=this._getDataServiceIndex(e.serviceName);if(n>=0){if(!t)throw new Error("A dataService with this name '"+e.serviceName+"' already exists in this MetadataStore");this.dataServices[n]=e}else this.dataServices.push(e)},p._getDataServiceIndex=function(e){return d(this.dataServices,function(t){return t.serviceName===e})},p.addEntityType=function(e){if(e instanceof Nt||e instanceof bt||(e=e.isComplexType?new bt(e):new Nt(e)),!e.isComplexType&&0===e.keyProperties.length)throw new Error("Unable to add "+e.name+" to this MetadataStore.  An EntityType must have at least one property designated as a key property - See the 'DataProperty.isPartOfKey' property.");if(e.metadataStore=this,e.isAnonymous||(this._structuralTypeMap[e.name]=e,this._shortNameMap[e.shortName]=e.name),e.getProperties().forEach(function(t){e._updateNames(t),t.isUnmapped||e._mappedPropertiesCount++}),e._updateCps(),!e.isComplexType){e._updateNps();var t=e.defaultResourceName||e.baseEntityType&&e.baseEntityType.defaultResourceName;t&&!this.getEntityTypeNameForResourceName(t)&&this.setEntityTypeForResourceName(t,e.name),e.defaultResourceName=t,e.getEntityCtor()}e.baseEntityType&&e.baseEntityType.subtypes.push(e)},p.exportMetadata=function(){var e=JSON.stringify({metadataVersion:Z.metadataVersion,namingConvention:this.namingConvention.name,localQueryComparisonOptions:this.localQueryComparisonOptions.name,dataServices:this.dataServices,structuralTypes:a(this._structuralTypeMap),resourceEntityTypeMap:this._resourceEntityTypeMap},null,pt.stringifyPad);return e},p.importMetadata=function(e){this._deferredTypes={};var t="string"==typeof e?JSON.parse(e):e;if(t.schema)return _t.parse(this,t.schema);if(t.metadataVersion&&t.metadataVersion!==Z.metadataVersion){var r=F("Cannot import metadata with a different 'metadataVersion' (%1) than the current 'breeze.metadataVersion' (%2) ",t.metadataVersion,Z.metadataVersion);throw new Error(r)}var a=t.namingConvention,i=t.localQueryComparisonOptions;if(this.isEmpty())this.namingConvention=pt._fetchObject(kt,a)||kt.defaultInstance,this.localQueryComparisonOptions=pt._fetchObject(Mt,i)||Mt.defaultInstance;else{if(a&&this.namingConvention.name!==a)throw new Error("Cannot import metadata with a different 'namingConvention' from the current MetadataStore");if(i&&this.localQueryComparisonOptions.name!==i)throw new Error("Cannot import metadata with different 'localQueryComparisonOptions' from the current MetadataStore")}var o=this;t.dataServices&&t.dataServices.forEach(function(e){e=wt.fromJSON(e),o.addDataService(e,!0)});var s=this._structuralTypeMap;return t.structuralTypes.forEach(function(e){var t=n(o,e);s[t.name]=t}),u(this._resourceEntityTypeMap,t.resourceEntityTypeMap),u(this._incompleteTypeMap,t.incompleteTypeMap),this},s.importMetadata=function(e){var t=new Tt;return t.importMetadata(e),t},p.hasMetadataFor=function(e){return!!this.getDataService(e)},p.getDataService=function(e){return at(e,"serviceName").isString().check(),e=wt._normalizeServiceName(e),h(this.dataServices,function(t){return t.serviceName===e})},p.fetchMetadata=function(e,n,r){if(at(e,"dataService").isString().or().isInstanceOf(wt).check(),at(n,"callback").isFunction().isOptional().check(),at(r,"errorCallback").isFunction().isOptional().check(),"string"==typeof e&&(e=this.getDataService(e)||new wt({serviceName:e})),e=wt.resolve([e]),this.hasMetadataFor(e.serviceName))throw new Error("Metadata for a specific serviceName may only be fetched once per MetadataStore. ServiceName: "+e.serviceName);return e.adapterInstance.fetchMetadata(this,e).then(function(e){return n&&n(e),t.resolve(e)}).fail(function(e){return r&&r(e),t.reject(e)})},p.trackUnmappedType=function(e,t){at(e,"entityCtor").isFunction().check(),at(t,"interceptor").isFunction().isOptional().check();var n=new Nt(this);n._setCtor(e,t)},p.registerEntityTypeCtor=function(e,t,n){at(e,"structuralTypeName").isString().check(),at(t,"aCtor").isFunction().isOptional().check(),at(n,"initializationFn").isOptional().isFunction().or().isString().check();var r=i(this,e,!1),a=r||e;if(this._ctorRegistry[a]={ctor:t,initFn:n},r){var o=this._structuralTypeMap[r];o&&o.getCtor(!0)}},p.toQueryString=function(e){if(!e)throw new Error("query cannot be empty");if("string"==typeof e)return e;if(e instanceof It)return e._toUri(this);throw new Error("unable to recognize query parameter as either a string or an EntityQuery")},p.isEmpty=function(){return k(this._structuralTypeMap)},p.getEntityType=function(e,t){return at(e,"structuralTypeName").isString().check(),at(t,"okIfNotFound").isBoolean().isOptional().check(!1),this._getEntityType(e,t)},p._getEntityType=function(e,t){var n=i(this,e,!1),r=this._structuralTypeMap[n];if(!r){if(t)return null;var a=F("Unable to locate a 'Type' by the name: '%1'. Be sure to execute a query or call fetchMetadata first.",e);throw new Error(a)}if(r.length){var o=r.join(",");throw new Error("There are multiple types with this 'shortName': "+o)}return r},p.getEntityTypes=function(){return e(this._structuralTypeMap)},p.getIncompleteNavigationProperties=function(){return a(this._incompleteTypeMap,function(e,t){return t})},p.getEntityTypeNameForResourceName=function(e){return at(e,"resourceName").isString().check(),this._resourceEntityTypeMap[e]},p.setEntityTypeForResourceName=function(e,t){at(e,"resourceName").isString().check(),at(t,"entityTypeOrName").isInstanceOf(Nt).or().isString().check();var n;n=t instanceof Nt?t.name:i(this,t,!0),this._resourceEntityTypeMap[e]=n;var r=this._getEntityType(n,!0);r&&!r.defaultResourceName&&(r.defaultResourceName=e)},p._checkEntityType=function(e){if(!e.entityType){var t=e.prototype._$typeName;if(!t)throw new Error("This entity has not been registered. See the MetadataStore.registerEntityTypeCtor method");var n=this._getEntityType(t);n&&(e.entityType=n)}},s}(),_t=function(){function e(e,n){e._entityTypeResourceMap={},f(n).forEach(function(n){if(n.cSpaceOSpaceMapping){var a=JSON.parse(n.cSpaceOSpaceMapping),i={};a.forEach(function(e){i[e[0]]=e[1]}),n.cSpaceOSpaceMapping=i}n.entityContainer&&f(n.entityContainer).forEach(function(t){f(t.entitySet).forEach(function(t){var r=d(t.entityType,n).typeName;e.setEntityTypeForResourceName(t.name,r),e._entityTypeResourceMap[r]=t.name})}),n.complexType&&f(n.complexType).forEach(function(t){r(t,n,e)}),n.entityType&&f(n.entityType).forEach(function(r){t(r,n,e)})});var a=e.getIncompleteNavigationProperties();if(a.length>0)throw new Error("Bad nav properties");return e}function t(e,t,r){var a=e.name,i=m(a,t),o=new Nt({shortName:a,namespace:i,isAbstract:e.abstract&&"true"===e.abstract});if(e.baseType){var s=d(e.baseType,t).typeName;o.baseTypeName=s;var u=r._getEntityType(s,!0);if(u)n(o,e,t,r,u);else{var p=r._deferredTypes[s];p||(p=[],r._deferredTypes[s]=p),p.push({entityType:o,csdlEntityType:e})}}else n(o,e,t,r,null);return o}function n(e,t,r,i,s){var p=[];s&&(e.baseEntityType=s,e.autoGeneratedKeyType=s.autoGeneratedKeyType,p=s.keyProperties.map(o("name")),s.dataProperties.forEach(function(t){var n=new Ot(t);n.isInherited=!0,e.addProperty(n)}),s.navigationProperties.forEach(function(t){var n=new Ct(t);n.isInherited=!0,e.addProperty(n)}));var c=t.key?f(t.key.propertyRef).map(o("name")):[];c=p.concat(c),f(t.property).forEach(function(t){a(e,t,r,c)}),f(t.navigationProperty).forEach(function(t){u(e,t,r)}),i.addEntityType(e),e.defaultResourceName=i._entityTypeResourceMap[e.name];var y=i._deferredTypes,l=y[e.name];l&&(l.forEach(function(t){n(t.entityType,t.csdlEntityType,r,i,e)}),delete y[e.name])}function r(e,t,n){var r=e.name,i=m(r,t),o=new bt({shortName:r,namespace:i});return f(e.property).forEach(function(e){a(o,e,t)}),n.addEntityType(o),o}function a(e,t,n,r){var a,o=t.type.split(".");return 2===o.length?a=i(e,t,r):p(t,n)?(a=i(e,t,r),a&&(a.enumType=t.type)):a=s(e,t,n),a&&(e.addProperty(a),c(a)),a}function i(e,t,n){var r=Pt.fromEdmDataType(t.type);if(null==r)return e.warnings.push("Unable to recognize DataType for property: "+t.name+" DateType: "+t.type),null;var a="true"===t.nullable||null==t.nullable,i=null!=n&&n.indexOf(t.name)>=0;i&&e.autoGeneratedKeyType===At.None&&y(t)&&(e.autoGeneratedKeyType=At.Identity);var o=t.maxLength;o=null==o||"Max"===o?null:parseInt(o,10);var s=new Ot({nameOnServer:t.name,dataType:r,isNullable:a,isPartOfKey:i,maxLength:o,concurrencyMode:t.concurrencyMode});return r===Pt.Undefined&&(s.rawTypeName=t.type),s}function s(e,t,n){var r=d(t.type,n).typeName,a=new Ot({nameOnServer:t.name,complexTypeName:r,isNullable:!1});return a}function u(e,t,n){var r=l(t,n),a=h(r.end,function(e){return e.role===t.toRole}),i="*"!==a.multiplicity,s=d(a.type,n).typeName,u=r.referentialConstraint;if(u){var p,c={nameOnServer:t.name,entityTypeName:s,isScalar:i,associationName:r.name},y=u.principal,m=u.dependent;t.fromRole===y.role?(p=f(y.propertyRef),c.invForeignKeyNamesOnServer=p.map(o("name"))):(p=f(m.propertyRef),c.foreignKeyNamesOnServer=p.map(o("name")));var g=new Ct(c);return e.addProperty(g),g}}function p(e,t){if(!t.enumType)return!1;var n=f(t.enumType),r=e.type.split("."),a=r[r.length-1];return n.some(function(e){return e.name===a})}function c(e){var t;if(e.isNullable||e.validators.push(lt.required()),!e.isComplexProperty){if(e.dataType===Pt.String)if(e.maxLength){var n={maxLength:e.maxLength};t=lt.maxLength(n)}else t=lt.string();else t=e.dataType.validatorCtor();e.validators.push(t)}}function y(e){var t=h(Object.keys(e),function(e){return e.indexOf("StoreGeneratedPattern")>=0});if(t)return"Identity"===e[t];var n=e.extensions;if(!n)return!1;var r=h(n,function(e){return"StoreGeneratedPattern"===e.name&&"Identity"===e.value});return!!r}function l(e,t){var n=d(e.relationship,t).shortTypeName,r=t.association;if(!r)return null;Array.isArray(r)||(r=[r]);var a=h(r,function(e){return e.name===n});return a}function d(e,t){if(!e)return null;if(D(e,Tt.ANONTYPE_PREFIX))return{shortTypeName:e,namespace:"",typeName:e,isAnon:!0};var n=e.split(",")[0],r=n.split(".");if(r.length>1){var a,i=r[r.length-1];if(t)a=m(i,t);else{var o=r.slice(0,r.length-1);a=o.join(".")}return{shortTypeName:i,namespace:a,typeName:q(i,a)}}return{shortTypeName:e,namespace:"",typeName:e}}function m(e,t){var n,r=t.cSpaceOSpaceMapping;if(r){var a=r[t.namespace+"."+e];n=a&&a.substr(0,a.length-(e.length+1))}return n||t.namespace}var g=_(function(e){return e&&d(e).typeName});return{parse:e,normalizeTypeName:g}}(),Nt=function(){function e(){return function(){}}function t(e){return e.filter(function(e){return!e.isInherited})}function r(e,t,n){var r=n+"OnServer",a=t[n];if(a&&a.length){if(t.isUnmapped)return;var i=f(a).map(function(n){var r=e.clientPropertyNameToServer(n,t),a=e.serverPropertyNameToClient(r,t);if(n!==a)throw new Error("NamingConvention for this client property name does not roundtrip properly:"+n+"-->"+a);
return r});t[r]=Array.isArray(a)?i:i[0]}else{var o=t[r];if(!o||0===o.length)return;var s=f(o).map(function(n){var r=e.serverPropertyNameToClient(n,t),a=e.clientPropertyNameToServer(r,t);if(n!==a)throw new Error("NamingConvention for this server property name does not roundtrip properly:"+n+"-->"+a);return r});t[n]=Array.isArray(o)?s:s[0]}}function a(e,t){var n=t._getEntityType(e.complexTypeName,!0);if(!n)return!1;if(!(n instanceof bt))throw new Error("Unable to resolve ComplexType with the name: "+e.complexTypeName+" for the property: "+property.name);return e.dataType=n,e.defaultValue=null,!0}function s(e,t){var n=t._getEntityType(e.entityTypeName,!0);if(!n)return!1;e.entityType=n;var r=h(n.navigationProperties,function(t){return t.associationName===e.associationName&&(t.name!==e.name||t.entityTypeName!==e.entityTypeName)});return e.inverse=r,r||e.invForeignKeyNames.forEach(function(t){var r=n.getDataProperty(t),a=e.parentType;r.inverseNavigationProperty=h(a.navigationProperties,function(e){return e.invForeignKeyNames&&e.invForeignKeyNames.indexOf(r.name)>=0}),n.foreignKeyProperties.push(r)}),u(e),!0}function u(e){var t=e.foreignKeyNames;if(0!==t.length){var n=e.parentType,r=t.map(function(e){return n.getDataProperty(e)});Array.prototype.push.apply(n.foreignKeyProperties,r),r.forEach(function(t){t.relatedNavigationProperty=e,e.relatedDataProperties?e.relatedDataProperties.push(t):e.relatedDataProperties=[t]})}}function p(e,t){var n=e.getPropertyNames(),r=ct.getDefaultInstance().getTrackablePropertyNames(t);r.forEach(function(t){if(-1===n.indexOf(t)){var r=new Ot({name:t,dataType:Pt.Undefined,isNullable:!0,isUnmapped:!0});e.addProperty(r)}})}var c=0,l=function(e){if(arguments.length>1)throw new Error("The EntityType ctor has a single argument that is either a 'MetadataStore' or a configuration object.");"MetadataStore"===e._$typeName?(this.metadataStore=e,this.shortName="Anon_"+ ++c,this.namespace="",this.isAnonymous=!0):ot(e).whereParam("shortName").isNonEmptyString().whereParam("namespace").isString().isOptional().withDefault("").whereParam("baseTypeName").isString().isOptional().whereParam("isAbstract").isBoolean().isOptional().withDefault(!1).whereParam("autoGeneratedKeyType").isEnumOf(At).isOptional().withDefault(At.None).whereParam("defaultResourceName").isNonEmptyString().isOptional().withDefault(null).whereParam("dataProperties").isOptional().whereParam("navigationProperties").isOptional().applyAll(this),this.name=q(this.shortName,this.namespace),this.dataProperties=[],this.navigationProperties=[],this.complexProperties=[],this.keyProperties=[],this.foreignKeyProperties=[],this.concurrencyProperties=[],this.unmappedProperties=[],this.validators=[],this.warnings=[],this._mappedPropertiesCount=0,this.subtypes=[],L(this,e.dataProperties,Ot),L(this,e.navigationProperties,Ct)},d=l.prototype;return d._$typeName="EntityType",d.setProperties=function(e){ot(e).whereParam("autoGeneratedKeyType").isEnumOf(At).isOptional().whereParam("defaultResourceName").isString().isOptional().applyAll(this),e.defaultResourceName&&(this.defaultResourceName=e.defaultResourceName)},d.isSubtypeOf=function(e){at(e,"entityType").isInstanceOf(Nt).check();var t=this;do{if(t===e)return!0;t=t.baseEntityType}while(t);return!1},d.getSelfAndSubtypes=function(){var e=[this];return this.subtypes.forEach(function(t){var n=t.getSelfAndSubtypes();e.push.apply(e,n)}),e},d.addProperty=function(e){if(at(e,"dataProperty").isInstanceOf(Ot).or().isInstanceOf(Ct).check(),this.metadataStore&&!e.isUnmapped)throw new Error("The '"+this.name+"' EntityType has already been added to a MetadataStore and therefore no additional properties may be added to it.");if(e.parentType){if(e.parentType!==this)throw new Error("This dataProperty has already been added to "+e.parentType.name);return this}return e.parentType=this,e.isDataProperty?this._addDataProperty(e):this._addNavigationProperty(e),this},d.createEntity=function(e){var t=this._createEntityCore();return e&&n(e,function(e,n){t.setProperty(e,n)}),t.entityAspect._postInitialize(),t},d._createEntityCore=function(){var e=this.getEntityCtor(),t=new e;return new mt(t),t},d.getCtor=d.getEntityCtor=function(t){if(this._ctor&&!t)return this._ctor;var n=this.metadataStore._ctorRegistry,r=n[this.name]||n[this.shortName]||{},a=r.ctor||this._ctor;if(!a){var i=ct.getDefaultInstance().createCtor;a=i?i(this):e()}return r.initFn&&(a._$initializationFn=r.initFn),a.prototype._$typeName=this.name,this._setCtor(a),a},d._setCtor=function(e,t){var n=new e,r=e.prototype;"EntityType"===this._$typeName?(p(this,n),r.entityType=this):(p(this,n),r.complexType=this),r._$interceptor=t?t:j,ct.getDefaultInstance().initializeEntityPrototype(r),this._ctor=e},d.addValidator=function(e,t){at(e,"validator").isInstanceOf(lt).check(),at(t,"property").isOptional().isString().or().isEntityProperty().check(),t?("string"==typeof t&&(t=this.getProperty(t,!0)),t.validators.push(e)):this.validators.push(e)},d.getProperties=function(){return this.dataProperties.concat(this.navigationProperties)},d.getPropertyNames=function(){return this.getProperties().map(o("name"))},d.getDataProperty=function(e,t){var n=t?"nameOnServer":"name";return h(this.dataProperties,i(n,e))},d.getNavigationProperty=function(e,t){var n=t?"nameOnServer":"name";return h(this.navigationProperties,i(n,e))},d.getProperty=function(e,t){t=t||!1;var n=Array.isArray(e)?e:e.trim().split("."),r=n[0],a=h(this.getProperties(),i("name",r));if(1===n.length){if(a)return a;if(t)throw new Error("unable to locate property: "+r+" on entityType: "+this.name);return null}if(a){n.shift();var o=a.isNavigationProperty?a.entityType:a.dataType;if(o)return o.getProperty(n,t);throw new Error("should not get here - unknown property type for: "+a.name)}if(t)throw new Error("unable to locate property: "+r+" on type: "+this.name);return null},d.toString=function(){return this.name},d.toJSON=function(){return y(this,{shortName:null,namespace:null,baseTypeName:null,isAbstract:!1,autoGeneratedKeyType:null,defaultResourceName:null,dataProperties:t,navigationProperties:t,validators:null})},d._clientPropertyPathToServer=function(e){var t=this.metadataStore.namingConvention.clientPropertyNameToServer,n=this,r=e.split(".").map(function(e){var r=n.getProperty(e);return t(e,r)}).join("/");return r},d._updateNames=function(e){var t=this.metadataStore.namingConvention;r(t,e,"name"),e.isNavigationProperty&&(r(t,e,"foreignKeyNames"),r(t,e,"invForeignKeyNames"))},d._checkNavProperty=function(e){if(e.isNavigationProperty){if(e.parentType!==this)throw new Error(F("The navigationProperty '%1' is not a property of entity type '%2'",e.name,this.name));return e}if("string"==typeof e){var t=this.getProperty(e);if(t&&t.isNavigationProperty)return t}throw new Error("The 'navigationProperty' parameter must either be a NavigationProperty or the name of a NavigationProperty")},d._addDataProperty=function(e){this.dataProperties.push(e),e.isPartOfKey&&this.keyProperties.push(e),e.isComplexProperty&&this.complexProperties.push(e),e.concurrencyMode&&"None"!==e.concurrencyMode&&this.concurrencyProperties.push(e),e.isUnmapped&&this.unmappedProperties.push(e)},d._addNavigationProperty=function(e){this.navigationProperties.push(e),R(e.entityTypeName)||(e.entityTypeName=q(e.entityTypeName,this.namespace))},d._updateCps=function(){var e=this.metadataStore,t=e._incompleteComplexTypeMap;this.complexProperties.forEach(function(n){n.complexType||a(n,e)||S(t,n.complexTypeName).push(n)}),this.isComplexType&&((t[this.name]||[]).forEach(function(t){a(t,e)}),delete t[this.name])},d._updateNps=function(){var e=this.metadataStore,t=e._incompleteTypeMap;this.navigationProperties.forEach(function(n){n.entityType||s(n,e)||S(t,n.entityTypeName).push(n)}),(t[this.name]||[]).forEach(function(t){s(t,e)}),delete t[this.name]},l}(),bt=function(){var e=function(e){if(arguments.length>1)throw new Error("The ComplexType ctor has a single argument that is a configuration object.");ot(e).whereParam("shortName").isNonEmptyString().whereParam("namespace").isString().isOptional().withDefault("").whereParam("dataProperties").isOptional().whereParam("isComplexType").isOptional().isBoolean().applyAll(this),this.name=q(this.shortName,this.namespace),this.isComplexType=!0,this.dataProperties=[],this.complexProperties=[],this.validators=[],this.concurrencyProperties=[],this.unmappedProperties=[],this.navigationProperties=[],this.keyProperties=[],L(this,e.dataProperties,Ot)},t=e.prototype;return t.createInstance=function(e){var t=this._createInstanceCore();return e&&n(e,function(e,n){t.setProperty(e,n)}),t.complexAspect._postInitialize(),t},t._createInstanceCore=function(e,t){var n=this.getCtor(),r=new n;return new gt(r,e,t),e&&r.complexAspect._postInitialize(),r},t.addProperty=function(e){if(at(e,"dataProperty").isInstanceOf(Ot).check(),this.metadataStore&&!e.isUnmapped)throw new Error("The '"+this.name+"' ComplexType has already been added to a MetadataStore and therefore no additional properties may be added to it.");if(e.parentType){if(e.parentType!==this)throw new Error("This dataProperty has already been added to "+property.parentType.name);return this}return this._addDataProperty(e),this},t.getProperties=function(){return this.dataProperties},t.addValidator=Nt.prototype.addValidator,t.getProperty=Nt.prototype.getProperty,t.getPropertyNames=Nt.prototype.getPropertyNames,t._addDataProperty=Nt.prototype._addDataProperty,t._updateNames=Nt.prototype._updateNames,t._updateCps=Nt.prototype._updateCps,t.getCtor=Nt.prototype.getEntityCtor,t._setCtor=Nt.prototype._setCtor,t.toJSON=function(){return y(this,{shortName:null,namespace:null,isComplexType:null,dataProperties:null,validators:null})},t._$typeName="ComplexType",e}(),Ot=function(){var e=function(e){ot(e).whereParam("name").isString().isOptional().whereParam("nameOnServer").isString().isOptional().whereParam("dataType").isEnumOf(Pt).isOptional().or().isString().or().isInstanceOf(bt).whereParam("complexTypeName").isOptional().whereParam("isNullable").isBoolean().isOptional().withDefault(!0).whereParam("isScalar").isOptional().withDefault(!0).whereParam("defaultValue").isOptional().whereParam("isPartOfKey").isBoolean().isOptional().whereParam("isUnmapped").isBoolean().isOptional().whereParam("concurrencyMode").isString().isOptional().whereParam("maxLength").isNumber().isOptional().whereParam("validators").isInstanceOf(lt).isArray().isOptional().withDefault([]).whereParam("enumType").isOptional().whereParam("rawTypeName").isOptional().applyAll(this);var t=!(!this.name&&!this.nameOnServer);if(!t)throw new Error("A DataProperty must be instantiated with either a 'name' or a 'nameOnServer' property");if(this.complexTypeName)this.isComplexProperty=!0,this.dataType=null;else if("string"==typeof this.dataType){var n=Pt.fromName(this.dataType);if(!n)throw new Error("Unable to find a DataType enumeration by the name of: "+this.dataType);this.dataType=n}else this.dataType||(this.dataType=Pt.String);if(null==this.defaultValue)if(this.isNullable)this.defaultValue=null;else if(this.isComplexProperty);else if(this.dataType===Pt.Binary)this.defaultValue="AAAAAAAAJ3U=";else if(this.defaultValue=this.dataType.defaultValue,null==this.defaultValue)throw new Error("A nonnullable DataProperty cannot have a null defaultValue. Name: "+this.name);this.isComplexProperty&&(this.isScalar=null==this.isScalar||this.isScalar===!0)},t=e.prototype;return t._$typeName="DataProperty",t.isDataProperty=!0,t.isNavigationProperty=!1,t.toJSON=function(){return y(this,{name:null,dataType:function(e){return e&&e.parentEnum?e.name:void 0},complexTypeName:null,isNullable:!0,defaultValue:null,isPartOfKey:!1,isUnmapped:!1,concurrencyMode:null,maxLength:null,validators:null,enumType:null,rawTypeName:null,isScalar:!0})},e.fromJSON=function(e){return e.dataType=Pt.fromName(e.dataType),e.defaultValue&&e.dataType&&e.dataType.isDate&&(e.defaultValue=new Date(Date.parse(e.defaultValue))),e.validators&&(e.validators=e.validators.map(lt.fromJSON)),new Ot(e)},e}(),Ct=function(){var e=function(e){ot(e).whereParam("name").isString().isOptional().whereParam("nameOnServer").isString().isOptional().whereParam("entityTypeName").isString().whereParam("isScalar").isBoolean().whereParam("associationName").isString().isOptional().whereParam("foreignKeyNames").isArray().isString().isOptional().withDefault([]).whereParam("foreignKeyNamesOnServer").isArray().isString().isOptional().withDefault([]).whereParam("invForeignKeyNames").isArray().isString().isOptional().withDefault([]).whereParam("invForeignKeyNamesOnServer").isArray().isString().isOptional().withDefault([]).whereParam("validators").isInstanceOf(lt).isArray().isOptional().withDefault([]).applyAll(this);var t=!(!this.name&&!this.nameOnServer);if(!t)throw new Error("A Navigation property must be instantiated with either a 'name' or a 'nameOnServer' property")},t=e.prototype;return t._$typeName="NavigationProperty",t.isDataProperty=!1,t.isNavigationProperty=!0,t.toJSON=function(){return y(this,{name:null,entityTypeName:null,isScalar:null,associationName:null,validators:null,foreignKeyNames:null,invForeignKeyNames:null})},e.fromJSON=function(e){return e.validators&&(e.validators=e.validators.map(lt.fromJSON)),new Ct(e)},e}(),At=function(){var e=new st("AutoGeneratedKeyType");return e.None=e.addSymbol(),e.Identity=e.addSymbol(),e.KeyGenerator=e.addSymbol(),e.seal(),e}();!function(){function e(e,t){return null==t?!1:void 0!==t.entityType}function t(e,t){return null==t?!1:t.isDataProperty||t.isNavigationProperty}var n=rt.prototype;n.isEntity=function(){return this._addContext({fn:e,msg:" must be an entity"})},n.isEntityProperty=function(){return this._addContext({fn:t,msg:" must be either a DataProperty or a NavigationProperty"})}}(),Z.MetadataStore=Tt,Z.EntityType=Nt,Z.ComplexType=bt,Z.DataProperty=Ot,Z.NavigationProperty=Ct,Z.AutoGeneratedKeyType=At,Tt.normalizeTypeName=_t.normalizeTypeName;var xt=function(){function e(e,t,n){var r=t.name+".."+t.parentType.name,a=e._tempIdMap[r];return a||n&&(a={entityType:t.parentType,propertyName:t.name,keyMap:{}},e._tempIdMap[r]=a),a}var t=function(){this._tempIdMap={}},n=t.prototype;return n.generateTempKeyValue=function(t,n){var r=t.keyProperties;if(r.length>1)throw new Error("Ids can not be autogenerated for entities with multipart keys");var a,i=r[0],o=e(this,i,!0);if(null!=n&&(o.keyMap[n.toString()]||(a=n)),void 0===a){var s=i.dataType;if(!s.getNext)throw new Error("Cannot use a property with a dataType of: "+s.toString()+" for id generation");for(a=s.getNext(this);null!=o.keyMap[a.toString()];)a=s.getNext(this)}return o.keyMap[a.toString()]=!0,a},n.getTempKeys=function(){var e=[];for(var t in this._tempIdMap){var n=this._tempIdMap[t],r=n.entityType;for(var a in n.keyMap)e.push(new vt(r,[a]))}return e},n.isTempKey=function(t){var n=t.entityType.keyProperties;if(n.length>1)return!1;var r=n[0],a=e(this,r);return a?void 0!==a.keyMap[t.values[0].toString()]:!1},pt.registerType(t,"KeyGenerator"),t}();Z.KeyGenerator=xt;var Mt=function(){var e=function(e){ot(e||{}).whereParam("name").isOptional().isString().whereParam("isCaseSensitive").isOptional().isBoolean().whereParam("usesSql92CompliantStringComparison").isBoolean().applyAll(this),this.name||(this.name=N()),pt._storeObject(this,t._$typeName,this.name)},t=e.prototype;return t._$typeName="LocalQueryComparisonOptions",e.caseInsensitiveSQL=new e({name:"caseInsensitiveSQL",isCaseSensitive:!1,usesSql92CompliantStringComparison:!0}),e.defaultInstance=new e(e.caseInsensitiveSQL),t.setAsDefault=function(){return c(this,e)},e}();Z.LocalQueryComparisonOptions=Mt;var kt=function(){var e=function(e){ot(e||{}).whereParam("name").isOptional().isString().whereParam("serverPropertyNameToClient").isFunction().whereParam("clientPropertyNameToServer").isFunction().applyAll(this),this.name||(this.name=N()),pt._storeObject(this,t._$typeName,this.name)},t=e.prototype;return t._$typeName="NamingConvention",e.none=new e({name:"noChange",serverPropertyNameToClient:function(e){return e},clientPropertyNameToServer:function(e){return e}}),e.camelCase=new e({name:"camelCase",serverPropertyNameToClient:function(e){return e.substr(0,1).toLowerCase()+e.substr(1)},clientPropertyNameToServer:function(e){return e.substr(0,1).toUpperCase()+e.substr(1)}}),e.defaultInstance=new e(e.none),t.setAsDefault=function(){return c(this,e)},e}();Z.NamingConvention=kt;var It=function(){function e(t,r,a,i){var o=a._$typeName||a.parentEnum&&a.parentEnum.name,s=o&&o.substr(0,1).toLowerCase()+o.substr(1);if(i&&s!=i)throw new Error("Invalid value for property: "+i);if(s){var u=r[s];if(void 0===u)throw new Error("Invalid config property: "+s);null===u?t[s]=a:u(t,a)}else n(a,function(n,a){e(t,r,a,n)})}function t(e){return at(e,"propertyPaths").isOptional().isString().or().isArray().isString().check(),"string"==typeof e&&(e=e.split(",")),e=e.map(function(e){return e.trim()})}function r(e){var t=e.entityType,n=t.keyProperties.map(function(t){return jt.create(t.name,Ft.Equals,e.getProperty(t.name))}),r=jt.and(n);return r}function a(e,t,n){var r,a=e._clone();return t?(r=Lt.create(t,n),a.orderByClause?a.orderByClause.addClause(r):a.orderByClause=r,a):(a.orderByClause=null,a)}function i(e,t){var n=e._clone();return t?(n.selectClause=new Gt(t),n):(n.selectClause=null,n)}function o(e,t){var n=e._clone();return t?(n.expandClause=new $t(t),n):(n.expandClause=null,n)}function s(e,t){var n=e._clone();return n.parameters=t,n}function p(e){var t=e.entityType.keyProperties,n=g(t,e.values,function(e,t){return jt.create(e.name,Ft.Equals,t)}),r=jt.and(n);return r}function c(e,t){if(t.isScalar){if(0===t.foreignKeyNames.length)return null;var n=t.foreignKeyNames.map(function(t){return e.getProperty(t)}),r=new vt(t.entityType,n);return p(r)}var a=t.inverse,i=a?a.foreignKeyNames:t.invForeignKeyNames;if(0===i.length)return null;var o=e.entityAspect.getKey().values,s=g(i,o,function(e,t){return jt.create(e,Ft.Equals,t)});return jt.and(s)}var y=function(e){at(e,"resourceName").isOptional().isString().check(),this.resourceName=e,this.entityType=null,this.wherePredicate=null,this.orderByClause=null,this.selectClause=null,this.skipCount=null,this.takeCount=null,this.expandClause=null,this.parameters={},this.inlineCountEnabled=!1,this.entityManager=null},l=y.prototype;return l._$typeName="EntityQuery",l.from=function(e){at(e,"resourceName").isString().check();var t=this.resourceName;if(t&&t!==e)throw new Error("This query already has an resourceName - the resourceName may only be set once per query");var n=this._clone();return n.resourceName=e,n},y.from=function(e){return at(e,"resourceName").isString().check(),new It(e)},l.toType=function(e){at(e,"entityType").isString().or().isInstanceOf(Nt).check();var t=this._clone();return t.resultEntityType=e,t},l.where=function(e){var t=this._clone();if(0===arguments.length)return t.wherePredicate=null,t;var n;return n=jt.isPredicate(e)?e:jt.create(tt(arguments)),t.entityType&&n.validate(t.entityType),t.wherePredicate=t.wherePredicate?new qt("and",[t.wherePredicate,n]):n,t},l.orderBy=function(e){return a(this,t(e))},l.orderByDesc=function(e){return a(this,t(e),!0)},l.select=function(e){return i(this,t(e))},l.skip=function(e){at(e,"count").isOptional().isNumber().check();var t=this._clone();return t.skipCount=0===arguments.length?null:e,t},l.top=function(e){return this.take(e)},l.take=function(e){at(e,"count").isOptional().isNumber().check();var t=this._clone();return t.takeCount=0===arguments.length?null:e,t},l.expand=function(e){return o(this,t(e))},l.withParameters=function(e){return at(e,"parameters").isObject().check(),s(this,e)},l.inlineCount=function(e){void 0===e&&(e=!0);var t=this._clone();return t.inlineCountEnabled=e,t},l.using=function(t){if(!t)return this;var n=this._clone();return e(n,{entityManager:null,dataService:null,queryOptions:null,fetchStrategy:function(e,t){e.queryOptions=(e.queryOptions||new Jt).using(t)},mergeStrategy:function(e,t){e.queryOptions=(e.queryOptions||new Jt).using(t)},jsonResultsAdapter:function(e,t){e.dataService=(e.dataService||new wt).using({jsonResultsAdapter:t})}},t),n},l.execute=function(e,t){if(!this.entityManager)throw new Error("An EntityQuery must have its EntityManager property set before calling 'execute'");return this.entityManager.executeQuery(this,e,t)},l.executeLocally=function(){if(!this.entityManager)throw new Error("An EntityQuery must have its EntityManager property set before calling 'executeLocally'");return this.entityManager.executeQueryLocally(this)},y.fromEntities=function(e){at(e,"entities").isEntity().or().isNonEmptyArray().isEntity().check(),Array.isArray(e)||(e=tt(arguments));var t=e[0],n=new It(t.entityType.defaultResourceName),a=e.map(function(e){return r(e)}),i=jt.or(a);n=n.where(i);var o=t.entityAspect.entityManager;return o&&(n=n.using(o)),n},y.fromEntityKey=function(e){at(e,"entityKey").isInstanceOf(vt).check();var t=new It(e.entityType.defaultResourceName),n=p(e);return t=t.where(n)},y.fromEntityNavigation=function(e,t){at(e,"entity").isEntity().check(),at(t,"navigationProperty").isInstanceOf(Ct).check();var n=e.entityType._checkNavProperty(t),r=new It(n.entityType.defaultResourceName),a=c(e,n);r=r.where(a);var i=e.entityAspect.entityManager;return i&&(r=r.using(i)),r},l._getFromEntityType=function(e,t){var n=this.entityType;if(n)return n;var r=this.resourceName;if(!r)throw new Error("There is no resourceName for this query");if(e.isEmpty()){if(t)throw new Error("There is no metadata available for this query");return null}var a=e.getEntityTypeNameForResourceName(r);if(n=a?e._getEntityType(a):this._getToEntityType(e,!0),!n){if(t)throw new Error(F("Cannot find an entityType for resourceName: '%1'.  Consider adding an 'EntityQuery.toType' call to your query or calling the MetadataStore.setEntityTypeForResourceName method to register an entityType for this resourceName.",r));return null}return this.entityType=n,n},l._getToEntityType=function(e,t){return this.resultEntityType instanceof Nt?this.resultEntityType:this.resultEntityType?(this.resultEntityType=e._getEntityType(this.resultEntityType,!1),this.resultEntityType):t?null:!this.selectClause&&this._getFromEntityType(e,!1)},l._clone=function(){var e=new It;return e.resourceName=this.resourceName,e.entityType=this.entityType,e.wherePredicate=this.wherePredicate,e.orderByClause=this.orderByClause,e.selectClause=this.selectClause,e.skipCount=this.skipCount,e.takeCount=this.takeCount,e.expandClause=this.expandClause,e.inlineCountEnabled=this.inlineCountEnabled,e.parameters=u({},this.parameters),e.queryOptions=this.queryOptions,e.entityManager=this.entityManager,e.dataService=this.dataService,e.resultEntityType=this.resultEntityType,e},l._toUri=function(e){function t(){var e=y.wherePredicate;if(e)return y.entityType&&e.validate(y.entityType),e.toOdataFragment(c)}function n(){return y.inlineCountEnabled?y.inlineCountEnabled?"allpages":"none":void 0}function r(){var e=y.orderByClause;if(e)return y.entityType&&e.validate(y.entityType),e.toOdataFragment(c)}function a(){var e=y.selectClause;if(e)return y.entityType&&e.validate(y.entityType),e.toOdataFragment(c)}function i(){var e=y.expandClause;if(e)return e.toOdataFragment(c)}function o(){var e=y.skipCount;if(e)return e.toString()}function s(){var e=y.takeCount;if(e)return e.toString()}function p(e){var t=[];for(var n in e){var r=e[n];void 0!==r&&t.push(n+"="+encodeURIComponent(r))}return t.length>0?"?"+t.join("&"):""}var c=this._getFromEntityType(e,!1);c||(c=new Nt(e));var y=this,l={};l.$filter=t(),l.$orderby=r(),l.$skip=o(),l.$top=s(),l.$expand=i(),l.$select=a(),l.$inlinecount=n(),l=u(l,this.parameters);var f=p(l);return this.resourceName+f},l._toFilterFunction=function(e){var t=this.wherePredicate;return t?(t.validate(e),t.toFunction(e)):null},l._toOrderByComparer=function(e){var t=this.orderByClause;return t?t.getComparer(e):null},y}(),Dt=function(){var e={toupper:{fn:function(e){return e.toUpperCase()},dataType:Pt.String},tolower:{fn:function(e){return e.toLowerCase()},dataType:Pt.String},substring:{fn:function(e,t,n){return e.substring(t,n)},dataType:Pt.String},substringof:{fn:function(e,t){return t.indexOf(e)>=0},dataType:Pt.Boolean},length:{fn:function(e){return e.length},dataType:Pt.Int32},trim:{fn:function(e){return e.trim()},dataType:Pt.String},concat:{fn:function(e,t){return e.concat(t)},dataType:Pt.String},replace:{fn:function(e,t,n){return e.replace(t,n)},dataType:Pt.String},startswith:{fn:function(e,t){return D(e,t)},dataType:Pt.Boolean},endswith:{fn:function(e,t){return V(e,t)},dataType:Pt.Boolean},indexof:{fn:function(e,t){return e.indexOf(t)},dataType:Pt.Int32},round:{fn:function(e){return Math.round(e)},dataType:Pt.Int32},ceiling:{fn:function(e){return Math.ceil(e)},dataType:Pt.Int32},floor:{fn:function(e){return Math.floor(e)},dataType:Pt.Int32},second:{fn:function(e){return e.second},dataType:Pt.Int32},minute:{fn:function(e){return e.minute},dataType:Pt.Int32},day:{fn:function(e){return e.day},dataType:Pt.Int32},month:{fn:function(e){return e.month},dataType:Pt.Int32},year:{fn:function(e){return e.year},dataType:Pt.Int32}};return e}(),Vt=function(){function e(e){var t=e.split(".");return 1===t.length?function(t){return t.getProperty(e)}:function(e){return B(e,t)}}var t=/^[a-z_][\w.$]*$/i,n=/('[^']*'|[^,]+)/g,r=/("[^"]*"|[^,]+)/g,a=function(a,i,o){var s=a.split(":");if(o&&(this.isValidated=!0),1===s.length){var u=s[0].trim();this.value=u;var p=u.substr(0,1),c="'"===p||'"'===p;if(c){var y=u.substr(1,u.length-2);this.fn=function(){return y},this.dataType=Pt.String}else{var l=t.test(u);if(l){if(o&&null==o.getProperty(u,!1))return void(this.isValidated=!1);this.propertyPath=u,this.fn=e(u)}else{if(o)return void(this.isValidated=!1);this.fn=function(){return u},this.dataType=Pt.fromValue(u)}}}else try{this.fnName=s[0].trim().toLowerCase();var f=Dt[this.fnName];this.localFn=f.fn,this.dataType=f.dataType;var h=this;this.fn=function(e){var t=h.fnNodes.map(function(t){var n=t.fn(e);return n}),n=h.localFn.apply(null,t);return n};var d=i[s[1]].trim();"("===d.substr(0,1)&&(d=d.substr(1,d.length-2));var m=a.indexOf("'")>=0?n:r,g=d.match(m);this.fnNodes=g.map(function(e){return new Vt(e,i)})}catch(v){this.isValidated=!1}},i=a.prototype;return a.create=function(e,t,n){if("string"!=typeof e)return null;for(var r,a=/\([^()]*\)/,i=[],o=0;r=a.exec(e);){var s=r[0];i.push(s);var u=":"+o++;e=e.replace(s,u)}var p=new Vt(e,i,t);return!p.dataType&&n&&n.isStringFn&&(p.dataType=Pt.String),p.isValidated===!1?null:p},i.toString=function(){if(this.fnName){var e=this.fnNodes.map(function(e){return e.toString()}),t=this.fnName+"("+e.join(",")+")";return t}return this.value},i.updateWithEntityType=function(e){if(this.propertyPath){if(e.isAnonymous)return;var t=e.getProperty(this.propertyPath);if(!t){var n=F("Unable to resolve propertyPath.  EntityType: '%1'   PropertyPath: '%2'",e.name,this.propertyPath);throw new Error(n)}this.dataType=t.dataType}},i.toOdataFragment=function(e){if(this.updateWithEntityType(e),this.fnName){var t=this.fnNodes.map(function(t){return t.toOdataFragment(e)}),n=this.fnName+"("+t.join(",")+")";return n}var r=this.value.substr(0,1);return"'"===r||'"'===r?this.value:this.value==this.propertyPath?e._clientPropertyPathToServer(this.propertyPath):this.value},i.validate=function(e){if(void 0===this.isValidated)if(this.isValidated=!0,this.propertyPath){var t=e.getProperty(this.propertyPath,!0);this.dataType=t.isDataProperty?t.dataType:t.entityType}else this.fnNodes&&this.fnNodes.forEach(function(t){t.validate(e)})},a}(),Ft=function(){var e=new st("FilterQueryOp");return e.Equals=e.addSymbol({operator:"eq",aliases:["=="]}),e.NotEquals=e.addSymbol({operator:"ne",aliases:["!="]}),e.GreaterThan=e.addSymbol({operator:"gt",aliases:[">"]}),e.LessThan=e.addSymbol({operator:"lt",aliases:["<"]}),e.GreaterThanOrEqual=e.addSymbol({operator:"ge",aliases:[">="]}),e.LessThanOrEqual=e.addSymbol({operator:"le",aliases:["<="]}),e.Contains=e.addSymbol({operator:"substringof",isFunction:!0,isStringFn:!0}),e.StartsWith=e.addSymbol({operator:"startswith",isFunction:!0,isStringFn:!0}),e.EndsWith=e.addSymbol({operator:"endswith",isFunction:!0,isStringFn:!0}),e.IsTypeOf=e.addSymbol({operator:"isof",isFunction:!0,aliases:["isTypeOf"]}),e.seal(),e._map=function(){var t={};return e.getSymbols().forEach(function(e){t[e.name.toLowerCase()]=e,t[e.operator.toLowerCase()]=e,e.aliases&&e.aliases.forEach(function(n){t[n.toLowerCase()]=e})}),t}(),e.from=function(t){return e.contains(t)?t:e._map[t.toLowerCase()]},e}(),Kt=function(){var e=new st("BooleanQueryOp");return e.And=e.addSymbol({operator:"and",aliases:["&&"]}),e.Or=e.addSymbol({operator:"or",aliases:["||"]}),e.Not=e.addSymbol({operator:"not",aliases:["~","!"]}),e.seal(),e._map=function(){var t={};return e.getSymbols().forEach(function(e){t[e.name.toLowerCase()]=e,t[e.operator.toLowerCase()]=e,e.aliases&&e.aliases.forEach(function(n){t[n.toLowerCase()]=e})}),t}(),e.from=function(t){return e.contains(t)?t:e._map[t.toLowerCase()]},e}(),jt=function(){function e(e){if(1===e.length&&Array.isArray(e[0]))return e[0];var t=tt(e);return jt.isPredicate(t[0])?t:[jt.create(t)]}var t=function(e,t,n,r){return arguments[0].prototype===!0?this:new Rt(e,t,n,r)},n=t.prototype;return t.isPredicate=function(e){return e instanceof jt},t.create=function(e,t,n,r){return Array.isArray(e)?(r=4===e.length?e[3]:!1,new Rt(e[0],e[1],e[2],r)):new Rt(e,t,n,r)},t.and=function(t){return t=e(arguments),1===t.length?t[0]:new qt("and",t)},t.or=function(t){return t=e(arguments),1===t.length?t[0]:new qt("or",t)},t.not=function(e){return new qt("not",[e])},n.and=function(n){return n=e(arguments),n.unshift(this),t.and(n)},n.or=function(n){return n=e(arguments),n.unshift(this),t.or(n)},n.not=function(){return new qt("not",[this])},t}(),Rt=function(){function e(e,i,o){var s,u=e.metadataStore.localQueryComparisonOptions,p=U(o);switch(i){case Ft.Equals:s=function(e,n){return e&&"string"==typeof e?t(e,n,u):p(e)==p(n)};break;case Ft.NotEquals:s=function(e,n){return e&&"string"==typeof e?!t(e,n,u):p(e)!=p(n)};break;case Ft.GreaterThan:s=function(e,t){return p(e)>p(t)};break;case Ft.GreaterThanOrEqual:s=function(e,t){return p(e)>=p(t)};break;case Ft.LessThan:s=function(e,t){return p(e)<p(t)};break;case Ft.LessThanOrEqual:s=function(e,t){return p(e)<=p(t)};break;case Ft.StartsWith:s=function(e,t){return n(e,t,u)};break;case Ft.EndsWith:s=function(e,t){return r(e,t,u)};break;case Ft.Contains:s=function(e,t){return a(e,t,u)};break;default:throw new Error("Unknown FilterQueryOp: "+i)}return s}function t(e,t,n){return null==t?!1:("string"!=typeof t&&(t=t.toString()),n.usesSql92CompliantStringComparison&&(e=(e||"").trim(),t=(t||"").trim()),n.isCaseSensitive||(e=(e||"").toLowerCase(),t=(t||"").toLowerCase()),e===t)}function n(e,t,n){return n.isCaseSensitive||(e=(e||"").toLowerCase(),t=(t||"").toLowerCase()),D(e,t)}function r(e,t,n){return n.isCaseSensitive||(e=(e||"").toLowerCase(),t=(t||"").toLowerCase()),V(e,t)}function a(e,t,n){return n.isCaseSensitive||(e=(e||"").toLowerCase(),t=(t||"").toLowerCase()),e.indexOf(t)>=0}var i=function(e,t,n,r){if(at(e,"propertyOrExpr").isString().isOptional().check(),at(t,"operator").isEnumOf(Ft).or().isString().check(),at(n,"value").isRequired(!0).check(),at(r).isOptional().isBoolean().check(),this._filterQueryOp=Ft.from(t),!this._filterQueryOp)throw new Error("Unknown query operation: "+t);if(e)this._propertyOrExpr=e,this._fnNode1=Vt.create(e,null,this._filterQueryOp);else if(this._filterQueryOp!==Ft.IsTypeOf)throw new Error("propertyOrExpr cannot be null except when using the 'IsTypeOf' operator");this._value=n,this._valueIsLiteral=r},o=new jt({prototype:!0});return i.prototype=o,o.toOdataFragment=function(e){if(this._filterQueryOp==Ft.IsTypeOf){var t=e.metadataStore.getEntityType(this._value),n=t.namespace+"."+t.shortName;return this._filterQueryOp.operator+"("+Pt.String.fmtOData(n)+")"}var r,a=this._fnNode1&&this._fnNode1.toOdataFragment(e);if(void 0!==this.fnNode2||this._valueIsLiteral||(this.fnNode2=Vt.create(this._value,e)),this.fnNode2)r=this.fnNode2.toOdataFragment(e);
else{var i=this._fnNode1.dataType||Pt.fromValue(this._value);r=i.fmtOData(this._value)}return this._filterQueryOp.isFunction?this._filterQueryOp==Ft.Contains?this._filterQueryOp.operator+"("+r+","+a+") eq true":this._filterQueryOp.operator+"("+a+","+r+") eq true":a+" "+this._filterQueryOp.operator+" "+r},o.toFunction=function(t){var n=this._fnNode1.dataType||Pt.fromValue(this._value),r=e(t,this._filterQueryOp,n),a=this._fnNode1.fn;if(void 0!==this.fnNode2||this._valueIsLiteral||(this.fnNode2=Vt.create(this._value,t)),this.fnNode2){var i=this.fnNode2.fn;return function(e){return r(a(e),i(e))}}var o=this._value;return function(e){return r(a(e),o)}},o.toString=function(){return F("{%1} %2 {%3}",this._propertyOrExpr,this._filterQueryOp.operator,this._value)},o.validate=function(e){this._fnNode1&&(this._fnNode1.validate(e),this.dataType=this._fnNode1.dataType)},i}(),qt=function(){function e(e,t,n){var r,a;switch(t){case Kt.Not:return r=n[0].toFunction(e),function(e){return!r(e)};case Kt.And:return a=n.map(function(t){return t.toFunction(e)}),function(e){var t=a.reduce(function(t,n){return t&&n(e)},!0);return t};case Kt.Or:return a=n.map(function(t){return t.toFunction(e)}),function(e){var t=a.reduce(function(t,n){return t||n(e)},!1);return t};default:throw new Error("Invalid boolean operator:"+t)}}var t=function(e,t){if(!Array.isArray(t))throw new Error("predicates parameter must be an array");if(this._booleanQueryOp=Kt.from(e),!this._booleanQueryOp)throw new Error("Unknown query operation: "+e);if(this._booleanQueryOp===Kt.Not&&1!==t.length)throw new Error("Only a single predicate can be passed in with the 'Not' operator");this._predicates=t},n=new jt({prototype:!0});return t.prototype=n,n.toOdataFragment=function(e){if(1==this._predicates.length)return this._booleanQueryOp.operator+" ("+this._predicates[0].toOdataFragment(e)+")";var t=this._predicates.map(function(t){return"("+t.toOdataFragment(e)+")"}).join(" "+this._booleanQueryOp.operator+" ");return t},n.toFunction=function(t){return e(t,this._booleanQueryOp,this._predicates)},n.toString=function(){if(1==this._predicates.length)return this._booleanQueryOp.operator+" ("+this._predicates[0]+")";var e=this._predicates.map(function(e){return"("+e.toString()+")"}).join(" "+this._booleanQueryOp.operator+" ");return e},n.validate=function(e){this._isValidated||(this._predicates.every(function(t){t.validate(e)}),this._isValidated=!0)},t}(),Lt=function(){var e=function(t,n){return t.prototype===!0?this:e.create(t,n)},t=e.prototype;return e.create=function(e,t){if(e.length>1){var n=e.map(function(e){return new Bt(e,t)});return new Ut(n)}return new Bt(e[0],t)},e.combine=function(e){return new Ut(e)},e.isOrderByClause=function(e){return e instanceof Lt},t.addClause=function(e){return new Ut([this,e])},e}(),Bt=function(){var e=function(e,t){if("string"!=typeof e)throw new Error("propertyPath is not a string");e=e.trim();var n=e.split(" ");if(n.length>1&&t!==!0&&t!==!1&&(t=D(n[1].toLowerCase(),"desc"),!t)){var r=D(n[1].toLowerCase(),"asc");if(!r)throw new Error("the second word in the propertyPath must begin with 'desc' or 'asc'")}this.propertyPath=n[0],this.isDesc=t},t=new Lt({prototype:!0});return e.prototype=t,t.validate=function(e){e&&(this.lastProperty=e.getProperty(this.propertyPath,!0))},t.toOdataFragment=function(e){return e._clientPropertyPathToServer(this.propertyPath)+(this.isDesc?" desc":"")},t.getComparer=function(e){if(this.lastProperty||this.validate(e),this.lastProperty)var t=this.lastProperty.dataType,n=this.lastProperty.parentType.metadataStore.localQueryComparisonOptions.isCaseSensitive;var r=this.propertyPath,a=this.isDesc;return function(e,i){var o=B(e,r),s=B(i,r),u=t||o&&Pt.fromValue(o)||Pt.fromValue(s);if(u===Pt.String)n?(o=o||"",s=s||""):(o=(o||"").toLowerCase(),s=(s||"").toLowerCase());else{var p=U(u);o=p(o),s=p(s)}return o===s?0:o>s||void 0===s?a?-1:1:a?1:-1}},e}(),Ut=function(){var e=function(e){var t=[];e.forEach(function(e){if(e instanceof Ut)t=t.concat(e.orderByClauses);else{if(!(e instanceof Bt))throw new Error("Invalid argument to CompositeOrderByClause ctor.");t.push(e)}}),this._orderByClauses=t},t=new Lt({prototype:!0});return e.prototype=t,t.validate=function(e){this._orderByClauses.forEach(function(t){t.validate(e)})},t.toOdataFragment=function(e){var t=this._orderByClauses.map(function(t){return t.toOdataFragment(e)});return t.join(",")},t.getComparer=function(e){var t=this._orderByClauses.map(function(t){return t.getComparer(e)});return function(e,n){for(var r=0;r<t.length;r++){var a=t[r](e,n);if(0!==a)return a}return 0}},e}(),Gt=function(){var e=function(e){this.propertyPaths=e,this._pathNames=e.map(function(e){return e.replace(".","_")})},t=e.prototype;return t.validate=function(e){e&&this.propertyPaths.forEach(function(t){e.getProperty(t,!0)})},t.toOdataFragment=function(e){var t=this.propertyPaths.map(function(t){return e._clientPropertyPathToServer(t)}).join(",");return t},t.toFunction=function(){var e=this;return function(t){var n={};return e.propertyPaths.forEach(function(r,a){n[e._pathNames[a]]=B(t,r)}),n}},e}(),$t=function(){var e=function(e){this.propertyPaths=e},t=e.prototype;return t.toOdataFragment=function(e){var t=this.propertyPaths.map(function(t){return e._clientPropertyPathToServer(t)}).join(",");return t},e}();Z.FilterQueryOp=Ft,Z.Predicate=jt,Z.EntityQuery=It,Z.FnNode=Vt,Z.OrderByClause=Lt;var zt=function(){var e=new st("MergeStrategy");return e.PreserveChanges=e.addSymbol(),e.OverwriteChanges=e.addSymbol(),e.seal(),e}(),Qt=function(){var e=new st("FetchStrategy");return e.FromServer=e.addSymbol(),e.FromLocalCache=e.addSymbol(),e.seal(),e}(),Jt=function(){function e(e,t){return t&&ot(t).whereParam("fetchStrategy").isEnumOf(Qt).isOptional().whereParam("mergeStrategy").isEnumOf(zt).isOptional().applyAll(e),e}var t=function(t){e(this,t)},n=t.prototype;return n._$typeName="QueryOptions",t.resolve=function(e){return new Jt(l(e,["fetchStrategy","mergeStrategy"]))},t.defaultInstance=new t({fetchStrategy:Qt.FromServer,mergeStrategy:zt.PreserveChanges}),n.using=function(t){if(!t)return this;var n=new Jt(this);return zt.contains(t)?t={mergeStrategy:t}:Qt.contains(t)&&(t={fetchStrategy:t}),e(n,t)},n.setAsDefault=function(){return c(this,t)},n.toJSON=function(){return y(this,{fetchStrategy:null,mergeStrategy:null})},t.fromJSON=function(e){return new Jt({fetchStrategy:Qt.fromName(e.fetchStrategy),mergeStrategy:zt.fromName(e.mergeStrategy)})},t}();Z.QueryOptions=Jt,Z.FetchStrategy=Qt,Z.MergeStrategy=zt;var Ht=function(){function e(e){if(e){if(1===e.length){var t=e[0];return function(e){return e?e.entityAspect.entityState===t:!1}}return function(t){return t?e.some(function(e){return t.entityAspect.entityState===e}):!1}}return function(e){return!!e}}var t=e([St.Added,St.Modified,St.Deleted]),n=function(e,t){this.entityManager=e,this.entityType=t,this._indexMap={},this._entities=[],this._emptyIndexes=[]},r=n.prototype;return r.attachEntity=function(e,t){var n,r=e.entityAspect,a=r.getKey()._keyInGroup;if(n=this._indexMap[a],n>=0){if(this._entities[n]===e)return r.entityState=t,e;throw new Error("This key is already attached: "+r.getKey())}return 0===this._emptyIndexes.length?n=this._entities.push(e)-1:(n=this._emptyIndexes.pop(),this._entities[n]=e),this._indexMap[a]=n,r.entityState=t,r.entityGroup=this,r.entityManager=this.entityManager,e},r.detachEntity=function(e){var t=e.entityAspect,n=t.getKey()._keyInGroup,r=this._indexMap[n];if(void 0===r)throw new Error("internal error - entity cannot be found in group");return delete this._indexMap[n],this._emptyIndexes.push(r),this._entities[r]=null,e},r.findEntityByKey=function(e){var t;t=e instanceof vt?e._keyInGroup:vt.createKeyString(e);var n=this._indexMap[t];return void 0!==n?this._entities[n]:null},r.hasChanges=function(){return this._entities.some(t)},r.getEntities=function(t){var n=e(t);return this._entities.filter(n)},r._clear=function(){this._entities.forEach(function(e){null!=e&&e.entityAspect._detach()}),this._entities=null,this._indexMap=null,this._emptyIndexes=null},r._fixupKey=function(e,t){var n=this._indexMap[e];if(void 0===n)throw new Error("Internal Error in key fixup - unable to locate entity");var r=this._entities[n],a=r.entityType.keyProperties[0].name;r.setProperty(a,t),delete r.entityAspect.hasTempKey,delete this._indexMap[e],this._indexMap[t]=n},r._replaceKey=function(e,t){var n=this._indexMap[e._keyInGroup];delete this._indexMap[e._keyInGroup],this._indexMap[t._keyInGroup]=n},n}(),Xt=function(){function e(e,t,n){var r=n?Jt.defaultInstance:e.queryOptions,a=n?Wt.defaultInstance:e.saveOptions,i=n?ht.defaultInstance:e.validationOptions,o=ot(t).whereParam("serviceName").isOptional().isString().whereParam("dataService").isOptional().isInstanceOf(wt).whereParam("queryOptions").isInstanceOf(Jt).isOptional().withDefault(r).whereParam("saveOptions").isInstanceOf(Wt).isOptional().withDefault(a).whereParam("validationOptions").isInstanceOf(ht).isOptional().withDefault(i).whereParam("keyGeneratorCtor").isFunction().isOptional();n&&(o=o.whereParam("metadataStore").isInstanceOf(Tt).isOptional().withDefault(new Tt)),o.applyAll(e),p(e.queryOptions,r),p(e.saveOptions,a),p(e.validationOptions,i),t.serviceName&&(e.dataService=new wt({serviceName:e.serviceName})),e.serviceName=e.dataService&&e.dataService.serviceName,e.keyGeneratorCtor=e.keyGeneratorCtor||xt,(n||t.keyGeneratorCtor)&&(e.keyGenerator=new e.keyGeneratorCtor)}function r(e,t){if(e.length!==t.length)return!1;for(var n=0,r=e.length;r>n;n++)if(e[n]!==t[n])return!1;return!0}function a(e,t){return at(t,"entityTypes").isString().isOptional().or().isNonEmptyArray().isString().or().isInstanceOf(Nt).or().isNonEmptyArray().isInstanceOf(Nt).check(),"string"==typeof t?t=e.metadataStore._getEntityType(t,!1):Array.isArray(t)&&"string"==typeof t[0]&&(t=t.map(function(t){return e.metadataStore._getEntityType(t,!1)})),t}function i(e,t,n){var r,a=_(e,t);return a.forEach(function(e){if(e){var t=e.getEntities(n);r?r.push.apply(r,t):r=t}}),r||[]}function o(e,t){if(t[0]instanceof vt)return{entityKey:t[0],remainingArgs:tt(t,1)};if("string"==typeof t[0]&&t.length>=2){var n=e.metadataStore._getEntityType(t[0],!1);return{entityKey:new vt(n,t[1]),remainingArgs:tt(t,2)}}throw new Error("This method requires as its initial parameters either an EntityKey or an entityType name followed by a value or an array of values.")}function u(e,t){e.forEach(function(e){e.entityAspect.isBeingSaved=t})}function c(e,t){var r;t?(r={},t.forEach(function(e){var t=r[e.entityType.name];t||(t={},t.entityType=e.entityType,t._entities=[],r[e.entityType.name]=t),t._entities.push(e)})):r=e._entityGroupMap;var a=[],i={};return n(r,function(e,t){i[e]=y(t,a)}),{entityGroupMap:i,tempKeys:a}}function y(e,t){var n={},r=e.entityType,a=r.dataProperties,i=[];return e._entities.forEach(function(e){if(e){var n=l(e,a,t);i.push(n)}}),n.entities=i,n}function l(e,t,n){var r={};t.forEach(function(t){var n=t.name,a=e.getProperty(n);if(null!=a||null!=t.defaultValue)if(a&&a.complexType){var i=t.dataType.dataProperties;r[n]=Array.isArray(a)?0==a.length?[]:a.map(function(e){return l(e,i)}):l(a,i)}else r[n]=a});var a,i;if(e.entityAspect){a=e.entityAspect;var o=a.entityState;i={tempNavPropNames:f(a,n),entityState:o.name},(o.isModified()||o.isDeleted())&&(i.originalValuesMap=a.originalValues),r.entityAspect=i}else a=e.complexAspect,i={},a.originalValues&&!k(a.originalValues)&&(i.originalValuesMap=a.originalValues),r.complexAspect=i;return r}function f(e,t){var n=e.entity;e.hasTempKey&&t.push(e.getKey().toJSON());var r;return n.entityType.navigationProperties.forEach(function(e){if(e.relatedDataProperties){var t=n.getProperty(e.name);t&&t.entityAspect.hasTempKey&&(r=r||[],r.push(e.name))}}),r}function d(e,t,n){var r=n.tempKeyMap,a=e.entityType,i=n.mergeStrategy===zt.OverwriteChanges,o=null,s=a.dataProperties,u=(a.keyProperties,e.entityManager.entityChanged);t.entities.forEach(function(t){var n,p=t.entityAspect,c=L(t,a,!0),y=St.fromName(p.entityState);if(y.isAdded()?(n=r[c.toString()],o=void 0===n?e.findEntityByKey(c):null):o=e.findEntityByKey(c),o){var l=o.entityAspect.entityState.isUnchanged();i||l?(R(o,t,s,!0),u.publish({entityAction:dt.MergeOnImport,entity:o}),l?y.isUnchanged()||e.entityManager._notifyStateChange(o,!0):y.isUnchanged()&&e.entityManager._notifyStateChange(o,!1)):o=null}else o=a._createEntityCore(),R(o,t,s,!0),void 0!==n&&(o.setProperty(a.keyProperties[0].name,n),p.tempNavPropNames&&p.tempNavPropNames.forEach(function(e){var t=a.getNavigationProperty(e),n=t.relatedDataProperties[0].name,i=o.getProperty(n),s=new vt(t.entityType,[i]),u=r[s.toString()];o.setProperty(n,u)})),o.entityAspect._postInitialize(),o=e.attachEntity(o,y),u&&(u.publish({entityAction:dt.AttachOnImport,entity:o}),y.isUnchanged()||e.entityManager._notifyStateChange(o,!0));o&&(o.entityAspect.entityState=y,y.isModified()&&(o.entityAspect.originalValuesMap=p.originalValues),e.entityManager._linkRelatedEntities(o))})}function v(e,n,r){return e=e.then(function(e){return n&&n(e),t.resolve(e)}).fail(function(e){return r&&r(e),t.reject(e)})}function w(e,t){var n;return n=t?t.filter(function(t){if(t.entityAspect.entityManager!==e)throw new Error("Only entities in this entityManager may be saved");return!t.entityAspect.entityState.isDetached()}):e.getChanges()}function E(e,t){e._inKeyFixup=!0,t.forEach(function(t){var n=e._entityGroupMap[t.entityTypeName];if(!n)throw new Error("Unable to locate the following fully qualified EntityType name: "+t.entityTypeName);n._fixupKey(t.tempValue,t.realValue)}),e._inKeyFixup=!1}function _(e,t){function n(){return new Error("The EntityManager.getChanges() 'entityTypes' parameter must be either an entityType or an array of entityTypes or null")}var r=e._entityGroupMap;if(t){if(t instanceof Nt)return[r[t.name]];if(Array.isArray(t))return t.map(function(e){if(e instanceof Nt)return r[e.name];throw n()});throw n()}return s(r)}function b(e,t){var n=t.entityAspect.getKey(),r=g(t.entityType.keyProperties,n.values,function(e,t){return e.defaultValue===t?e:null}).filter(function(e){return null!==e});if(r.length)if(t.entityType.autoGeneratedKeyType!==At.None)e.generateTempKeyValue(t);else if(r.length===n.values.length)throw new Error("Cannot attach an object to an EntityManager without first setting its key or setting its entityType 'AutoGeneratedKeyType' property to something other than 'None'")}function O(e,t){function n(){return new Error("The EntityManager.getChanges() 'entityStates' parameter must either be null, an entityState or an array of entityStates")}if(!t)return null;if(St.contains(t))t=[t];else{if(!Array.isArray(t))throw n();t.forEach(function(e){if(!St.contains(e))throw n()})}return t}function A(e,t,n){var r=nt(e,t.entityType);r.attachEntity(t,n),e._linkRelatedEntities(t)}function x(e,t,n){var r=t.entityType.navigationProperties;r.forEach(function(r){var a=t.getProperty(r.name);if(r.isScalar){if(!a)return;e.attachEntity(a,n)}else a.forEach(function(t){e.attachEntity(t,n)})})}function M(e,n,r,a){try{var i=e.metadataStore;if(i.isEmpty()&&a.hasServerMetadata)throw new Error("cannot execute _executeQueryCore until metadataStore is populated.");if(r.fetchStrategy===Qt.FromLocalCache)return t.fcall(function(){var t=e.executeQueryLocally(n);return{results:t,query:n}});var o=a.makeUrl(i.toQueryString(n)),s={url:o,query:n,entityManager:e,dataService:a,queryOptions:r,refMap:{},deferredFns:[]},u=e.validationOptions.validateOnQuery;return a.adapterInstance.executeQuery(s).then(function(r){var i=T(function(){var t={isLoading:e.isLoading};return e.isLoading=!0,e._pendingPubs=[],t},function(r){e.isLoading=r.isLoading,e._pendingPubs.forEach(function(e){e()}),e._pendingPubs=null,n=null,s=null,r.error&&t.reject(r.error)},function(){var t=a.jsonResultsAdapter.extractResults(r);Array.isArray(t)||(t=null==t?[]:[t]);var i=t.map(function(e){var t=I(e,s,{nodeType:"root"});return u&&t.entityAspect&&t.entityAspect.validateEntity(),t});return s.deferredFns.length>0&&s.deferredFns.forEach(function(e){e()}),{results:i,query:n,entityManager:e,XHR:r.XHR,inlineCount:r.inlineCount}});return t.resolve(i)}).fail(function(r){return r&&(r.query=n,r.entityManager=e),t.reject(r)})}catch(p){return p&&(p.query=n),t.reject(p)}}function I(e,t,n){if(null==t.query&&e.entityAspect)return e.entityAspect.entityState.isDeleted()?t.entityManager.detachEntity(e):e.entityAspect.acceptChanges(),e;n=n||{};var r=t.dataService.jsonResultsAdapter.visitNode(e,t,n)||{};return t.query&&"root"===n.nodeType&&!r.entityType&&(r.entityType=t.query._getToEntityType&&t.query._getToEntityType(t.entityManager.metadataStore)),D(e,t,r)}function D(e,t,n,r){if(n.ignore||null==e)return null;if(n.nodeRefId){var a=V(n.nodeRefId,t);return"function"==typeof a?void t.deferredFns.push(function(){r(a)}):a}return n.entityType?n.entityType.isComplexType?e:F(e,t,n):(n.nodeId&&(t.refMap[n.nodeId]=e),"object"!=typeof e||C(e)?e:K(e,t))}function V(e,t){var n=t.refMap[e];return void 0===n?function(){return t.refMap[e]}:n}function F(e,t,n){e._$meta=n;var r=t.entityManager,a=n.entityType;"string"==typeof a&&(a=r.metadataStore._getEntityType(a,!1)),e.entityType=a;var i=t.queryOptions.mergeStrategy,o=null==t.query,s=L(e,a,!1),u=r.findEntityByKey(s);if(u){if(o&&u.entityAspect.entityState.isDeleted())return r.detachEntity(u),u;var p=u.entityAspect.entityState;if(i===zt.OverwriteChanges||p.isUnchanged()){j(u,e,t),u.entityAspect.wasLoaded=!0,n.extra&&(u.entityAspect.extraMetadata=n.extra),u.entityAspect.entityState=St.Unchanged,u.entityAspect.originalValues={},u.entityAspect.propertyChanged.publish({entity:u,propertyName:null});var c=o?dt.MergeOnSave:dt.MergeOnQuery;r.entityChanged.publish({entityAction:c,entity:u}),p.isUnchanged||r._notifyStateChange(u,!1)}else $(t,u,e),a.navigationProperties.forEach(function(n){n.isScalar?Q(e,n,t):X(e,n,t)})}else u=a._createEntityCore(),u.initializeFrom&&u.initializeFrom(e),j(u,e,t),u.entityAspect._postInitialize(),n.extra&&(u.entityAspect.extraMetadata=n.extra),A(r,u,St.Unchanged),u.entityAspect.wasLoaded=!0,r.entityChanged.publish({entityAction:dt.AttachOnQuery,entity:u});return u}function K(e,t){var r=t.entityManager,a=t.dataService.jsonResultsAdapter,i=r.metadataStore.namingConvention.serverPropertyNameToClient,o={};return n(e,function(e,n){var r=a.visitNode(n,t,{nodeType:"anonProp",propertyName:e})||{};if(!r.ignore){var s=i(e);o[s]=Array.isArray(n)?n.map(function(n,i){return r=a.visitNode(n,t,{nodeType:"anonPropItem",propertyName:e})||{},D(n,t,r,function(e){o[s][i]=e()})}):D(n,t,r,function(e){o[s]=e()})}}),o}function j(e,t,n){$(n,e,t);var r=e.entityType;R(e,t,r.dataProperties,!1),r.navigationProperties.forEach(function(r){r.isScalar?z(r,e,t,n):H(r,e,t,n)})}function R(e,t,n,r){if(n.forEach(function(n){q(e,t,n,r)}),r){var a=e.entityAspect?"entityAspect":"complexAspect",i=t[a].originalValuesMap;i&&(e[a].originalValues=i)}}function q(e,t,n,r){var a=r?B:U,i=a(t,n);if(void 0!==i){var o;if(n.isComplexProperty){o=e.getProperty(n.name);var s=n.dataType.dataProperties;n.isScalar?R(o,i,s,r):(o.length=0,i.forEach(function(t){var a=n.dataType._createInstanceCore(e,n);R(a,t,s,r),o.push(a)}))}else{var u;n.isScalar?(u=G(n,i),e.setProperty(n.name,u)):(o=e.getProperty(n.name),o.length=0,i.forEach(function(e){u=G(n,e),o.push(u)}))}}}function L(e,t,n){var r=n?B:U,a=t.keyProperties.map(function(t){return G(t,r(e,t))});return new vt(t,a)}function B(e,t){return e[t.name]}function U(e,t){return e[t.nameOnServer||t.isUnmapped&&t.name]}function G(e,t){return void 0===t?void 0:(e.dataType.isDate&&t?C(t)||(t=Pt.parseDateFromServer(t)):e.dataType===Pt.Binary&&t&&void 0!==t.$value&&(t=t.$value),t)}function $(e,t,n){var r=n._$meta.nodeId;null!=r&&(e.refMap[r]=t)}function z(e,t,n,r){var a=Q(n,e,r);null!=a&&("function"==typeof a?r.deferredFns.push(function(){a=a(),J(a,t,e)}):J(a,t,e))}function Q(e,t,n){var r=e[t.nameOnServer];if(!r)return null;var a=I(r,n,{nodeType:"navProp",navigationProperty:t});return a}function J(e,t,n){if(e){var r=n.name,a=t.getProperty(r);if(a!==e){t.setProperty(r,e);var i=n.inverse;if(!i)return;if(i.isScalar)e.setProperty(i.name,t);else{var o=e.getProperty(i.name);o.push(t)}}}}function H(e,t,n,r){var a=X(n,e,r);if(null!=a){var i=e.inverse;if(i){var o=t.getProperty(e.name);o.wasLoaded=!0,a.forEach(function(e){"function"==typeof e?r.deferredFns.push(function(){e=e(),W(e,o,t,i)}):W(e,o,t,i)})}}}function X(e,t,n){var r=e[t.nameOnServer];if(!r)return null;if(!Array.isArray(r))return null;var a=r.map(function(e){return I(e,n,{nodeType:"navPropItem",navigationProperty:t})});return a}function W(e,t,n,r){if(e){var a=e.getProperty(r.name);a!==n&&(t.push(e),e.setProperty(r.name,n))}}function Y(e){var t=e.filter(function(e){return e.entityAspect.isBeingSaved=!0,e.entityAspect.entityState.isModified()&&e.entityType.concurrencyProperties.length>0});0!==t.length&&t.forEach(function(e){e.entityType.concurrencyProperties.forEach(function(t){et(e,t)})})}function et(e,t){if(!e.entityAspect.originalValues[t.name]){var n=e.getProperty(t.name);if(n||(n=t.dataType.defaultValue),t.dataType.isNumeric)e.setProperty(t.name,n+1);else if(t.dataType.isDate){for(var r=new Date,a=new Date;r.getTime()===a.getTime();)a=new Date;e.setProperty(t.name,a)}else{if(t.dataType!==Pt.Guid){if(t.dataType===Pt.Binary)return;throw new Error("Unable to update the value of concurrency property before saving: "+t.name)}e.setProperty(t.name,N())}}}function nt(e,t){var n=e._entityGroupMap[t.name];return n||(n=new Ht(e,t),e._entityGroupMap[t.name]=n),n}function rt(e,t){var n=t.getSelfAndSubtypes();return n.map(function(t){return nt(e,t)})}function it(e,t){var n={},r=e.entityType||e.complexType;return r.dataProperties.forEach(function(r){if(r.isUnmapped){if(t)return;var a=e.getProperty(r.name);a=yt(a,r,!1),void 0!==a&&(n.__unmapped=n.__unmapped||{},n.__unmapped[r.name]=a)}else if(r.isComplexProperty)if(r.isScalar)n[r.nameOnServer]=it(e.getProperty(r.name),t);else{var i=e.getProperty(r.name);n[r.nameOnServer]=i.map(function(e){return it(e,t)})}else{var a=e.getProperty(r.name);a=yt(a,r,t),void 0!==a&&(n[r.nameOnServer]=a)}}),n}function st(e,t,r){var a=e.entityType||e.complexType,i=e.entityAspect||e.complexAspect,o=t.namingConvention.clientPropertyNameToServer,s={};return n(i.originalValues,function(e,t){var n=a.getProperty(e);t=yt(t,n,r),void 0!==t&&(s[o(e,n)]=t)}),a.complexProperties.forEach(function(n){var a=e.getProperty(n.name);if(n.isScalar){var i=st(a,t,r);k(i)||(s[o(n.name,n)]=i)}else{var u=a.map(function(e){return st(e,t,r)});s[o(n.name,n)]=u}}),s}function ct(e,t,r){var a=e.entityType||e.complexType,i=e.entityAspect||e.complexAspect,o=t.namingConvention.clientPropertyNameToServer,s={};return n(i.originalValues,function(t){var n=a.getProperty(t),i=e.getProperty(t);i=yt(i,n,r),void 0!==i&&(s[o(t,n)]=i)}),a.complexProperties.forEach(function(n){var r=e.getProperty(n.name);if(n.isScalar){var a=ct(r,t);k(a)||(s[o(n.name,n)]=a)}else{var i=r.map(function(e){return ct(e,t)});s[o(n.name,n)]=i}}),s}function yt(e,t,n){if(n){if(t.isUnmapped)return;t.dataType===Pt.DateTimeOffset?e=e&&new Date(e.getTime()-6e4*e.getTimezoneOffset()):t.dataType.quoteJsonOData&&(e=null!=e?e.toString():e)}return e}function lt(){this.map={}}var ft=function(t){if(arguments.length>1)throw new Error("The EntityManager ctor has a single optional argument that is either a 'serviceName' or a configuration object.");0===arguments.length?t={serviceName:""}:"string"==typeof t&&(t={serviceName:t}),e(this,t,!0),this.entityChanged=new ut("entityChanged",this),this.validationErrorsChanged=new ut("validationErrorsChanged",this),this.hasChangesChanged=new ut("hasChangesChanged",this),this.clear()},gt=ft.prototype;return gt._$typeName="EntityManager",ut.bubbleEvent(gt,null),gt.setProperties=function(t){e(this,t,!1)},gt.createEntity=function(e,t,n){at(e,"entityType").isString().or().isInstanceOf(Nt).check(),"string"==typeof e&&(e=this.metadataStore._getEntityType(e)),n=n||St.Added;var r;return P(this,"isLoading",!0,function(){r=e.createEntity(t)}),n!==St.Detached&&this.attachEntity(r,n),r},ft.importEntities=function(e,t){var n=new Xt;return n.importEntities(e,t),n},gt.exportEntities=function(e){var t=c(this,e),n={metadataStore:this.metadataStore.exportMetadata(),dataService:this.dataService,saveOptions:this.saveOptions,queryOptions:this.queryOptions,validationOptions:this.validationOptions,tempKeys:t.tempKeys,entityGroupMap:t.entityGroupMap},r=JSON.stringify(n,null,pt.stringifyPad);return r},gt.importEntities=function(e,t){t=t||{},ot(t).whereParam("mergeStrategy").isEnumOf(zt).isOptional().withDefault(this.queryOptions.mergeStrategy).applyAll(t);var r=this,a="string"==typeof e?JSON.parse(e):e;this.metadataStore.importMetadata(a.metadataStore),this.dataService=a.dataService&&wt.fromJSON(a.dataService)||new wt({serviceName:a.serviceName}),this.saveOptions=new Wt(a.saveOptions),this.queryOptions=Jt.fromJSON(a.queryOptions),this.validationOptions=new ht(a.validationOptions);var i={};return a.tempKeys.forEach(function(e){var t=vt.fromJSON(e,r.metadataStore);i[t.toString()]=r.keyGenerator.generateTempKeyValue(t.entityType,t.values[0])}),t.tempKeyMap=i,T(function(){r._pendingPubs=[]},function(){r._pendingPubs.forEach(function(e){e()}),r._pendingPubs=null},function(){n(a.entityGroupMap,function(e,n){var a=r.metadataStore._getEntityType(e,!0),i=nt(r,a);d(i,n,t)})}),this},gt.clear=function(){n(this._entityGroupMap,function(e,t){t._clear()}),this._entityGroupMap={},this._unattachedChildrenMap=new lt,this.keyGenerator=new this.keyGeneratorCtor,this.entityChanged.publish({entityAction:dt.Clear}),this._hasChanges&&(this._hasChanges=!1,this.hasChangesChanged.publish({entityManager:this,hasChanges:!1}))},gt.createEmptyCopy=function(){var e=new ft({dataService:this.dataService,metadataStore:this.metadataStore,queryOptions:this.queryOptions,saveOptions:this.saveOptions,validationOptions:this.validationOptions,keyGeneratorCtor:this.keyGeneratorCtor});return e},gt.addEntity=function(e){return this.attachEntity(e,St.Added)},gt.attachEntity=function(e,t){if(at(e,"entity").isRequired().check(),this.metadataStore._checkEntityType(e),t=at(t,"entityState").isEnumOf(St).isOptional().check(St.Unchanged),e.entityType.metadataStore!==this.metadataStore)throw new Error("Cannot attach this entity because the EntityType and MetadataStore associated with this entity does not match this EntityManager's MetadataStore.");var n=e.entityAspect;n||(n=new mt(e),n._postInitialize(e));var r=n.entityManager;if(r){if(r===this)return e;throw new Error("This entity already belongs to another EntityManager")}var a=this;return P(this,"isLoading",!0,function(){t.isAdded()&&b(a,e),A(a,e,t),x(a,e,t)}),this.validationOptions.validateOnAttach&&e.entityAspect.validateEntity(),t.isUnchanged()||this._notifyStateChange(e,!0),this.entityChanged.publish({entityAction:dt.Attach,entity:e}),e},gt.detachEntity=function(e){at(e,"entity").isEntity().check();var t=e.entityAspect;if(!t)return!1;if(t.entityManager!==this)throw new Error("This entity does not belong to this EntityManager.");return t.setDetached()},gt.fetchMetadata=function(e,t,n){"function"==typeof e?(n=t,t=e,e=null):(at(e,"dataService").isInstanceOf(wt).isOptional().check(),at(t,"callback").isFunction().isOptional().check(),at(n,"errorCallback").isFunction().isOptional().check());var r=this.metadataStore.fetchMetadata(e||this.dataService);return v(r,t,n)},gt.executeQuery=function(e,t,n){at(e,"query").isInstanceOf(It).or().isString().check(),at(t,"callback").isFunction().isOptional().check(),at(n,"errorCallback").isFunction().isOptional().check();var r,a=Jt.resolve([e.queryOptions,this.queryOptions,Jt.defaultInstance]),i=wt.resolve([e.dataService,this.dataService]);if(!i.hasServerMetadata||this.metadataStore.hasMetadataFor(i.serviceName))r=M(this,e,a,i);else{var o=this;r=this.fetchMetadata(i).then(function(){return M(o,e,a,i)})}return v(r,t,n)},gt.executeQueryLocally=function(e){at(e,"query").isInstanceOf(It).check();var t=this.metadataStore,n=e._getFromEntityType(t,!0),r=rt(this,n),a=e._toFilterFunction(n);if(a)var i=function(e){return e&&!e.entityAspect.entityState.isDeleted()&&a(e)};else var i=function(e){return e&&!e.entityAspect.entityState.isDeleted()};var o=[];r.forEach(function(e){o.push.apply(o,e._entities.filter(i))});var s=e._toOrderByComparer(n);s&&o.sort(s);var u=e.skipCount;u&&(o=o.slice(u));var p=e.takeCount;p&&(o=o.slice(0,p));var c=e.selectClause;if(c){var y=c.toFunction();o=o.map(function(e){return y(e)})}return o},gt.saveChanges=function(e,n,a,i){at(e,"entities").isOptional().isArray().isEntity().check(),at(n,"saveOptions").isInstanceOf(Wt).isOptional().check(),at(a,"callback").isFunction().isOptional().check(),at(i,"errorCallback").isFunction().isOptional().check(),n=n||this.saveOptions||Wt.defaultInstance;var o=null==e,s=w(this,e);if(0===s.length){var p={entities:[],keyMappings:[]};return a&&a(p),t.resolve(p)}if(!n.allowConcurrentSaves){var c=s.some(function(e){return e.entityAspect.isBeingSaved});if(c){var y=new Error("Concurrent saves not allowed - SaveOptions.allowConcurrentSaves is false");return i&&i(y),t.reject(y)}}if(this.validationOptions.validateOnSave){var l=s.filter(function(e){var t=e.entityAspect,n=t.entityState.isDeleted()||t.validateEntity();return!n});if(l.length>0){var f=new Error("Validation error");return f.entitiesWithErrors=l,i&&i(f),t.reject(f)}}Y(s);var h=wt.resolve([n.dataService,this.dataService]),d={entityManager:this,dataService:h,resourceName:n.resourceName||this.saveOptions.resourceName||"SaveChanges"},m={mergeStrategy:zt.OverwriteChanges},g={entities:s,saveOptions:n},v=this;return h.adapterInstance.saveChanges(d,g).then(function(e){E(v,e.keyMappings);var n={query:null,entityManager:v,queryOptions:m,dataService:h,refMap:{},deferredFns:[]},i=e.entities.map(function(e){return I(e,n,{nodeType:"root"})});return u(s,!1),v._hasChanges=o&&r(s,i)?!1:v._hasChangesCore(),v._hasChanges||v.hasChangesChanged.publish({entityManager:v,hasChanges:!1}),e.entities=i,a&&a(e),t.resolve(e)},function(e){return u(s,!1),i&&i(e),t.reject(e)})},gt._findEntityGroup=function(e){return this._entityGroupMap[e.name]},gt.getEntityByKey=function(){var e,t=o(this,arguments).entityKey,n=t._subtypes;if(!n)return e=this._findEntityGroup(t.entityType),e&&e.findEntityByKey(t);for(var r=0,a=n.length;a>r;r++){e=this._findEntityGroup(n[r]);var i=e&&e.findEntityByKey(t);if(i)return i}},gt.fetchEntityByKey=function(){var e,n=o(this,arguments),r=n.entityKey,a=0===n.remainingArgs.length?!1:!!n.remainingArgs[0],i=!1;return a&&(e=this.getEntityByKey(r),i=e&&e.entityAspect.entityState.isDeleted(),i&&(e=null,this.queryOptions.mergeStrategy===zt.OverwriteChanges&&(i=!1))),e||i?t.resolve({entity:e,entityKey:r,fromCache:!0}):It.fromEntityKey(r).using(this).execute().then(function(n){return e=0===n.results.length?null:n.results[0],t.resolve({entity:e,entityKey:r,fromCache:!1})})},gt.findEntityByKey=function(e){return this.getEntityByKey(e)},gt.generateTempKeyValue=function(e){at(e,"entity").isEntity().check();var t=e.entityType,n=this.keyGenerator.generateTempKeyValue(t),r=t.keyProperties[0];return e.setProperty(r.name,n),e.entityAspect.hasTempKey=!0,n},gt.hasChanges=function(e){return this._hasChanges?void 0===e?this._hasChanges:this._hasChangesCore(e):!1},gt._hasChangesCore=function(e){e=a(this,e);var t=_(this,e);return t.some(function(e){return e.hasChanges()})},gt.getChanges=function(e){e=a(this,e);var t=[St.Added,St.Modified,St.Deleted];return i(this,e,t)},gt.rejectChanges=function(){if(!this._hasChanges)return[];var e=[St.Added,St.Modified,St.Deleted],t=i(this,null,e);return this._hasChanges=!1,t.forEach(function(e){e.entityAspect.rejectChanges()}),this.hasChangesChanged.publish({entityManager:this,hasChanges:!1}),t},gt.getEntities=function(e,t){return e=a(this,e),at(t,"entityStates").isOptional().isEnumOf(St).or().isNonEmptyArray().isEnumOf(St).check(),t&&(t=O(this,t)),i(this,e,t)},gt._notifyStateChange=function(e,t){this.entityChanged.publish({entityAction:dt.EntityStateChange,entity:e}),t?this._hasChanges||(this._hasChanges=!0,this.hasChangesChanged.publish({entityManager:this,hasChanges:!0})):this._hasChanges&&(this._hasChanges=this._hasChangesCore(),this._hasChanges||this.hasChangesChanged.publish({entityManager:this,hasChanges:!1}))
},gt._linkRelatedEntities=function(e){var t=this,n=e.entityAspect;P(t,"isLoading",!0,function(){var r=t._unattachedChildrenMap,a=n.getKey(),i=r.getTuples(a);i&&i.forEach(function(t){var n,i,o=t.children.filter(function(e){return e.entityAspect.entityState!==St.Detached}),s=t.navigationProperty;if(s.inverse)if(n=s,i=s.inverse,i.isScalar){var u=o[0];e.setProperty(i.name,u),u.setProperty(n.name,e)}else{var p=e.getProperty(i.name);o.forEach(function(t){p.push(t),t.setProperty(n.name,e)})}else if(s.parentType===e.entityType)if(i=s,i.isScalar)e.setProperty(i.name,o[0]);else{var p=e.getProperty(i.name);o.forEach(function(e){p._push(e)})}else n=s,o.forEach(function(t){t.setProperty(n.name,e)});r.removeChildren(a,n)}),e.entityType.navigationProperties.forEach(function(a){if(a.isScalar){var i=e.getProperty(a.name);if(i)return}var o=n.getParentKey(a);if(o){if(o._isEmpty())return;var s=t.findEntityByKey(o);s?e.setProperty(a.name,s):r.addChild(o,a,e)}}),e.entityType.foreignKeyProperties.forEach(function(n){var a=n.inverseNavigationProperty;if(a){var i=e.getProperty(n.name),o=new vt(a.parentType,[i]),s=t.findEntityByKey(o);s?a.isScalar?s.setProperty(a.name,e):t.isLoading?s.getProperty(a.name)._push(e):s.getProperty(a.name).push(e):r.addChild(o,a,e)}})})},gt.helper={unwrapInstance:it,unwrapOriginalValues:st,unwrapChangedValues:ct,getEntityKeyFromRawEntity:L,visitAndMerge:I},gt._mergeEntities=function(e,t){var n=Z.DataService.resolve([this.dataService]),r={query:t,dataService:n,entityManager:this,queryOptions:this.queryOptions,refMap:{},url:"",deferedFns:[]},a={nodeType:"root"};return e.map(function(e){return I(e,r,a)})},lt.prototype.addChild=function(e,t,n){var r=this.getTuple(e,t);r||(r={navigationProperty:t,children:[]},S(this.map,e.toString()).push(r)),r.children.push(n)},lt.prototype.removeChildren=function(e,t){var n=this.map[e.toString()];n&&(m(n,function(e){return e.navigationProperty===t}),n.length||delete this.map[e.toString()])},lt.prototype.getChildren=function(e,t){var n=this.getTuple(e,t);return n?n.children.filter(function(e){return!e.entityAspect.entityState.isDetached()}):null},lt.prototype.getTuple=function(e,t){var n=this.map[e.toString()];if(!n)return null;var r=h(n,function(e){return e.navigationProperty===t});return r},lt.prototype.getTuples=function(e){return this.map[e.toString()]},ft}();Z.EntityManager=Xt;var Wt=function(){function e(e,t){return t&&ot(t).whereParam("resourceName").isOptional().isString().whereParam("dataService").isOptional().isInstanceOf(wt).whereParam("allowConcurrentSaves").isBoolean().isOptional().whereParam("tag").isOptional().applyAll(e),e}var t=function(t){e(this,t)},n=t.prototype;return n._$typeName="SaveOptions",n.setAsDefault=function(){return c(this,t)},n.using=function(t){return e(this,t)},t.defaultInstance=new t({allowConcurrentSaves:!1}),t}();Z.SaveOptions=Wt,Z.AbstractDataServiceAdapter=function(){var e,n=function(){};return n.prototype.checkForRecomposition=function(e){"ajax"===e.interfaceName&&e.isDefault&&this.initialize()},n.prototype.initialize=function(){if(e=Z.config.getAdapterInstance("ajax"),!e)throw new Error("Unable to initialize ajax for WebApi.");var t=e.ajax;if(!t)throw new Error("Breeze was unable to find an 'ajax' adapter")},n.prototype.fetchMetadata=function(n,r){var a=r.serviceName,i=r.makeUrl("Metadata"),o=t.defer(),s=this;return e.ajax({url:i,dataType:"json",success:function(e,t,s){var u;if(n.hasMetadataFor(a))return o.resolve("already fetched");var p="string"==typeof e?JSON.parse(e):e;if(p)try{n.importMetadata(p)}catch(c){u=new Error("Metadata import failed for "+i+"; Unable to process returned metadata:"+c.message)}else u=new Error("Metadata query failed for: "+i);return u?o.reject(u):(n.hasMetadataFor(a)||n.addDataService(r),s.onreadystatechange=null,s.abort=null,void o.resolve(p))},error:function(e){s._handleXHRError(o,e,"Metadata query failed for: "+i)}}),o.promise},n.prototype.executeQuery=function(n){var r=t.defer(),a=this,i={url:n.url,dataType:"json",success:function(e,t,n){try{var i;i=e&&e.Results?{results:e.Results,inlineCount:e.InlineCount,XHR:n}:{results:e,XHR:n},r.resolve(i),n.onreadystatechange=null,n.abort=null}catch(o){var s=o instanceof Error?o:a._createError(n);r.reject(s),n.onreadystatechange=null,n.abort=null}},error:function(e){a._handleXHRError(r,e)}};return n.dataService.useJsonp&&(i.dataType="jsonp",i.crossDomain=!0),e.ajax(i),r.promise},n.prototype.saveChanges=function(n,r){var a=t.defer();r=this._prepareSaveBundle(r,n);var i=JSON.stringify(r),o=n.dataService.makeUrl(n.resourceName),s=this;return e.ajax({url:o,type:"POST",dataType:"json",contentType:"application/json",data:i,success:function(e,t,r){var i=e.Error||e.error;if(i){var o=s._createError(r);o.message=i,a.reject(o)}else{var u=s._prepareSaveResult(n,e);a.resolve(u)}},error:function(e){s._handleXHRError(a,e)}}),a.promise},n.prototype._prepareSaveBundle=function(){throw new Error("Need a concrete implementation of _prepareSaveBundle")},n.prototype._prepareSaveResult=function(){throw new Error("Need a concrete implementation of _prepareSaveResult")},n.prototype.jsonResultsAdapter=new Et({name:"noop",visitNode:function(){return{}}}),n.prototype._handleXHRError=function(e,t,n){var r=this._createError(t);n&&(r.message=n+"; "+r.message),e.reject(r),t.onreadystatechange=null,t.abort=null},n.prototype._createError=function(e){var t=new Error;if(t.XHR=e,t.responseText=e.responseText,t.status=e.status,t.statusText=e.statusText,t.message=e.statusText,t.responseText)try{var n=JSON.parse(e.responseText);t.detail=n;var r=n.InnerException||n;t.message=r.ExceptionMessage||r.Message||e.responseText}catch(a){t.message=t.message+": "+t.responseText}return t},n}();var Yt,nt=Z.core,Zt=function(){this.name="jQuery",this.defaultSettings={}};Zt.prototype.initialize=function(){Yt=nt.requireLib("jQuery")},Zt.prototype.ajax=function(e){if(!Yt)throw new Error("Unable to locate jQuery");if(nt.isEmpty(this.defaultSettings))Yt.ajax(e);else{var t=nt.extend({},this.defaultSettings);nt.extend(t,e),Yt.ajax(t)}},Z.config.registerAdapter("ajax",Zt);var en,nt=Z.core,Tt=Z.MetadataStore,Et=Z.JsonResultsAdapter,Zt=function(){this.name="OData"};Zt.prototype.initialize=function(){en=nt.requireLib("OData","Needed to support remote OData services"),en.jsonHandler.recognizeDates=!0},Zt.prototype.executeQuery=function(e){var n=t.defer();return en.read(e.url,function(e){return n.resolve({results:e.results,inlineCount:e.__count})},function(t){return n.reject(z(t,e.url))}),n.promise},Zt.prototype.fetchMetadata=function(e,n){var r=t.defer(),a=n.serviceName,i=n.makeUrl("$metadata");return en.read(i,function(t){if(!t||!t.dataServices){var o=new Error("Metadata query failed for: "+i);return r.reject(o)}var s=t.dataServices;if(!e.hasMetadataFor(a)){try{e.importMetadata(s)}catch(u){return r.reject(new Error("Metadata query failed for "+i+"; Unable to process returned metadata: "+u.message))}e.addDataService(n)}return r.resolve(s)},function(e){var t=z(e,i);return t.message="Metadata query failed for: "+i+"; "+(t.message||""),r.reject(t)},en.metadataHandler),r.promise},Zt.prototype.saveChanges=function(e,n){var r=t.defer(),a=e.entityManager.helper,i=e.dataService.makeUrl("$batch"),o=G(e,n),s=e.tempKeys,u=e.contentKeys;return en.request({headers:{DataServiceVersion:"2.0"},requestUri:i,method:"POST",data:o},function(e){var t=[],n=[],o={entities:t,keyMappings:n};return e.__batchResponses.forEach(function(e){e.__changeResponses.forEach(function(e){var o=e.response||e,p=o.statusCode;if(!p||p>=400)return r.reject(z(e,i));var c=e.headers["Content-ID"],y=e.data;if(y){var l=s[c];if(l){var f=l.entityType;if(f.autoGeneratedKeyType!==At.None){var h=l.values[0],d=a.getEntityKeyFromRawEntity(y,f,!1),m={entityTypeName:f.name,tempValue:h,realValue:d.values[0]};n.push(m)}}t.push(y)}else{var g=u[c];t.push(g)}})}),r.resolve(o)},function(e){return r.reject(z(e,i))},en.batchHandler),r.promise},Zt.prototype.jsonResultsAdapter=new Et({name:"OData_default",visitNode:function(e,t,n){var r={};if(null==e)return r;if(null!=e.__metadata){var a=Tt.normalizeTypeName(e.__metadata.type),i=a&&t.entityManager.metadataStore.getEntityType(a,!0);i&&i._mappedPropertiesCount===Object.keys(e).length-1&&(r.entityType=i,r.extra=e.__metadata)}var o=n.propertyName;return r.ignore=null!=e.__deferred||"__metadata"===o||"EntityKey"===o&&e.$type&&nt.stringStartsWith(e.$type,"System.Data"),r}}),Z.config.registerAdapter("dataService",Zt);var nt=Z.core,Tt=Z.MetadataStore,Et=Z.JsonResultsAdapter,tn=Z.AbstractDataServiceAdapter,Zt=function(){this.name="webApi"};Zt.prototype=new tn,Zt.prototype._prepareSaveBundle=function(e,t){var n=t.entityManager,r=n.metadataStore,a=n.helper;return e.entities=e.entities.map(function(e){var t=a.unwrapInstance(e),n=null;e.entityType.autoGeneratedKeyType!==At.None&&(n={propertyName:e.entityType.keyProperties[0].nameOnServer,autoGeneratedKeyType:e.entityType.autoGeneratedKeyType.name});var i=a.unwrapOriginalValues(e,r);return t.entityAspect={entityTypeName:e.entityType.name,defaultResourceName:e.entityType.defaultResourceName,entityState:e.entityAspect.entityState.name,originalValuesMap:i,autoGeneratedKey:n},t}),e.saveOptions={tag:e.saveOptions.tag},e},Zt.prototype._prepareSaveResult=function(e,t){var n=t.KeyMappings.map(function(e){var t=Tt.normalizeTypeName(e.EntityTypeName);return{entityTypeName:t,tempValue:e.TempValue,realValue:e.RealValue}});return{entities:t.Entities,keyMappings:n,XHR:t.XHR}},Zt.prototype.jsonResultsAdapter=new Et({name:"webApi_default",visitNode:function(e,t,n){if(null==e)return{};var r=Tt.normalizeTypeName(e.$type),a=r&&t.entityManager.metadataStore._getEntityType(r,!0),i=n.propertyName,o=i&&"$"===i.substr(0,1);return{entityType:a,nodeId:e.$id,nodeRefId:e.$ref,ignore:o}}}),Z.config.registerAdapter("dataService",Zt);var nn,rn,an,on,nt=Z.core,gt=Z.ComplexAspect,sn=Object.prototype.hasOwnProperty,Zt=function(){this.name="backbone"};Zt.prototype.initialize=function(){nn=nt.requireLib("Backbone"),rn=nt.requireLib("_;underscore"),an=nn.Model.prototype.set,on=nn.Model.prototype.get},Zt.prototype.createCtor=function(e){var t={};e.dataProperties.forEach(function(e){t[e.name]=e.defaultValue});var n=nn.Model.extend({defaults:t,initialize:function(){if(e.navigationProperties){var t=this;e.navigationProperties.forEach(function(e){if(!e.isScalar){var n=Z.makeRelationArray([],t,e);nn.Model.prototype.set.call(t,e.name,n)}})}}});return n},Zt.prototype.getTrackablePropertyNames=function(e){var t=[];for(var n in e.attributes)t.push(n);return t},Zt.prototype.initializeEntityPrototype=function(e){e.getProperty=function(e){return this.get(e)},e.setProperty=function(e,t){return this.set(e,t),this},e.set=function(e,t,n){var r=this.entityAspect||this.complexAspect;if(!r)return an.call(this,e,t,n);var a,i,o,s=this,u=this.entityType||this.complexType;if(rn.isObject(e)||null==e){if(a=e,n=t,!this._validate(a,n))return!1;for(o in a)if(sn.call(a,o)){if(i=u.getProperty(o),null==i)throw new Error("Unknown property: "+e);var p=function(e){return function(t){return 0===arguments.length?on.call(s,e):an.call(s,e,t,n)}}(o);this._$interceptor(i,a[o],p)}}else{if(a={},a[e]=t,n||(n={}),!this._validate(a,n))return!1;if(i=u.getProperty(e),null==i)throw new Error("Unknown property: "+e);o=e,this._$interceptor(i,t,function(e){return 0===arguments.length?on.call(s,o):an.call(s,o,e,n)})}return this}},Zt.prototype.startTracking=function(e){if(!(e instanceof nn.Model))throw new Error("This entity is not an Backbone.Model instance");var t=e.entityType||e.complexType,n=e.attributes;t.dataProperties.forEach(function(t){var r=t.name,a=n[r];t.isComplexProperty?a=t.isScalar?t.dataType._createInstanceCore(e,t):Z.makeComplexArray([],e,t):t.isScalar?void 0===a&&(a=t.defaultValue):a=Z.makePrimitiveArray([],e,t),an.call(e,r,a)}),t.navigationProperties&&t.navigationProperties.forEach(function(t){var r;if(t.name in n){var a=on.call(e,t.name);if(t.isScalar){if(a&&!a.entityType)throw r=nt.formatString("The value of the '%1' property for entityType: '%2' must be either null or another entity",t.name,e.entityType.name),new Error(r)}else if(a){if(!a.parentEntity)throw r=nt.formatString("The value of the '%1' property for entityType: '%2' must be either null or a Breeze relation array",t.name,e.entityType.name),new Error(r)}else a=Z.makeRelationArray([],e,t),an.call(e,t.name,a)}else t.isScalar?an.call(e,t.name,null):(a=Z.makeRelationArray([],e,t),an.call(e,t.name,a))})},Z.config.registerAdapter("modelLibrary",Zt);var nt=Z.core,Zt=function(){this.name="backingStore"};Zt.prototype.initialize=function(){},Zt.prototype.getTrackablePropertyNames=function(e){var t=[];for(var n in e)if("entityType"!==n&&"_$typeName"!==n&&"_pendingSets"!==n&&"_backingStore"!==n){var r=e[n];nt.isFunction(r)||t.push(n)}return t},Zt.prototype.initializeEntityPrototype=function(e){e.getProperty=function(e){return this[e]},e.setProperty=function(e,t){if(!this._backingStore.hasOwnProperty(e))throw new Error("Unknown property name:"+e);return this[e]=t,this},e.initializeFrom=function(e){var t=this;this.entityType.unmappedProperties.forEach(function(n){var r=n.name;e[r]=t[r]}),this._backingStore||(this._backingStore={})},e._pendingSets=[],e._pendingSets.schedule=function(e,t,n){if(this.push({entity:e,propName:t,value:n}),!this.isPending){this.isPending=!0;var r=this;setTimeout(function(){r.process()})}},e._pendingSets.process=function(){0!==this.length&&(this.forEach(function(e){e.entity._backingStore||(e.entity._backingStore={}),e.entity._backingStore[e.propName]=e.value}),this.length=0,this.isPending=!1)},J(e)},Zt.prototype.startTracking=function(e,t){t._pendingSets.process();var n=H(e),r=e.entityType||e.complexType;r.getProperties().forEach(function(t){var r=t.name,a=e[r];if(t.isDataProperty)t.isComplexProperty?a=t.isScalar?t.dataType._createInstanceCore(e,t):Z.makeComplexArray([],e,t):t.isScalar?void 0===a&&(a=t.defaultValue):a=Z.makePrimitiveArray([],e,t),n[r]=a;else{if(!t.isNavigationProperty)throw new Error("unknown property: "+r);if(void 0!==a)throw new Error("Cannot assign a navigation property in an entity ctor.: "+t.Name);n[r]=t.isScalar?null:Z.makeRelationArray([],e,t)}})},Z.config.registerAdapter("modelLibrary",Zt);var e,nt=Z.core,Zt=function(){this.name="ko"};return Zt.prototype.initialize=function(){e.extenders.intercept=function(t,n){var r,a=n.instance,i=n.property;return r=e.computed(t.splice?{read:t}:{read:t,write:function(e){return a._$interceptor(i,e,t),a}})}},Zt.prototype.getTrackablePropertyNames=function(t){var n=[];for(var r in t)if("entityType"!==r&&"_$typeName"!==r){var a=t[r];e.isObservable(a)?n.push(r):nt.isFunction(a)||n.push(r)}return n},Zt.prototype.initializeEntityPrototype=function(e){e.getProperty=function(e){return this[e]()},e.setProperty=function(e,t){return this[e](t),this}},Zt.prototype.startTracking=function(t){var n=t.entityType||t.complexType;n.getProperties().sort(function(e,t){var n=e.isUnmapped?1:0,r=t.isUnmapped?1:0;return n-r}).forEach(function(n){var r,a=n.name,i=t[a];if(e.isObservable(i)){if(n.isNavigationProperty)throw new Error("Cannot assign a navigation property in an entity ctor.: "+a);r=i}else if(n.isDataProperty)n.isComplexProperty?i=n.isScalar?n.dataType._createInstanceCore(t,n):Z.makeComplexArray([],t,n):n.isScalar?void 0===i&&(i=n.defaultValue):i=Z.makePrimitiveArray([],t,n),r=e.observable(i);else{if(!n.isNavigationProperty)throw new Error("unknown property: "+a);if(void 0!==i)throw new Error("Cannot assign a navigation property in an entity ctor.: "+a);n.isScalar?r=e.observable(null):(i=Z.makeRelationArray([],t,n),r=e.observableArray(i),i._koObj=r,r.subscribe(W,null,"beforeChange"),i.arrayChanged.subscribe(Y),r.equalityComparer=function(){throw new Error("Collection navigation properties may NOT be set.")})}if(n.isNavigationProperty&&!n.isScalar)t[a]=r;else{var o=r.extend({intercept:{instance:t,property:n}});t[a]=o}})},Z.config.registerAdapter("modelLibrary",Zt),Z.config.initializeAdapterInstances({dataService:"webApi",ajax:"jQuery"}),Z.config.initializeAdapterInstance("modelLibrary","ko"),Z});